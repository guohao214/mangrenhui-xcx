'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = Page({
  data: {
    '__code__': {
      readme: ''
    },

    amount: 0,
    orderType: '',
    orderId: '',
    lastComponent: '',
    formId: '',
    lastIndex: '',
    orderList: [],
    payType: '',
    beauticianCode: '',
    couponCode: ''
  },
  onLoad: function onLoad(options) {
    // console.log(options)
  },
  onShow: function onShow() {
    this.getOrderList();
  },
  getOrderList: function getOrderList() {
    var _this = this;

    var app = getApp();
    app.get('center/order', { order_status: 1 }).then(function (data) {
      var result = data.data;
      result.content.forEach(function (item) {
        return item.appointment_end_time = _this._realDay(item.appointment_day, item.appointment_end_time);
      });
      _this.setData({
        orderList: result.content
      });
    });
  },
  payOffline: function payOffline() {
    var _this2 = this;

    var app = getApp();
    if (this.data.payType === 'cash') {
      if (this.data.beauticianCode.trim().length === 0) {
        wx.showToast({
          title: '技师工号不能为空',
          icon: 'none'
        });

        return;
      }
    }

    // 团购
    if (this.data.payType === 'group') {
      if (!this.data.couponCode.match(/^\d{10}$/) && !this.data.couponCode.match(/^\d{12}$/)) {
        wx.showToast({
          title: '券号输入错误,券号位数为10位或者12位',
          icon: 'none'
        });

        return;
      }
    }

    app.post('center/completeOrder/' + this.data.orderId, {
      type: this.data.payType,
      beautician_code: this.data.beauticianCode, coupon_code: this.data.couponCode
    }).then(function () {
      _this2.getOrderList();
      _this2.cancel();
    }).catch(function (error) {
      wx.showToast({
        title: error.detail || '支付失败，请重试',
        duration: 2000,
        icon: 'none'
      });
    });
  },
  payOnline: function payOnline() {
    var app = getApp();
    app.get('order/pay/' + this.data.orderNo).then(function (data) {
      var result = data.data;
      var payParams = {
        'success': function success(res) {
          var _this3 = this;

          wx.showToast({
            title: '支付成功,等待数据确认，请稍等...',
            duration: 3000,
            icon: 'none'
          });

          this.cancel();

          setTimeout(function (x) {
            return _this3.getOrderList();
          }, 2000);
        },
        'fail': function fail(res) {
          wx.showToast({
            title: '支付失败, 请重试...',
            duration: 2000,
            icon: 'none'
          });
        }
      };

      Object.assign(payParams, result.content);

      wx.requestPayment(payParams);
    }).catch(function (error) {
      wx.showToast({
        title: error.detail || '支付失败，请重试',
        duration: 2000,
        icon: 'none'
      });
    });
  },
  cash: function cash(event) {
    var id = event.currentTarget.dataset.id;
    this.setData({
      payType: 'cash',
      orderId: id
    });
    var dialogComponent = this.data.lastComponent = this.selectComponent('.wxc-cash');
    dialogComponent && dialogComponent.show();
  },
  handlerBeautician: function handlerBeautician(event) {
    var value = event.detail.value;
    this.setData({
      beauticianCode: value
    });
  },
  handlerCouponCode: function handlerCouponCode(event) {
    var value = event.detail.value;
    this.setData({
      couponCode: value
    });
  },
  scan: function scan(event) {
    var id = event.currentTarget.dataset.id;
    this.setData({
      payType: 'scan',
      orderId: id
    });
    var dialogComponent = this.data.lastComponent = this.selectComponent('.wxc-scan');
    dialogComponent && dialogComponent.show();
  },
  groupBy: function groupBy(event) {
    var id = event.currentTarget.dataset.id;
    this.setData({
      payType: 'group',
      orderId: id
    });
    var dialogComponent = this.data.lastComponent = this.selectComponent('.wxc-group');
    dialogComponent && dialogComponent.show();
  },
  online: function online(event) {
    var orderNo = event.currentTarget.dataset.id;
    var amount = event.currentTarget.dataset.amount;
    this.setData({
      payType: 'online',
      orderNo: orderNo,
      amount: amount
    });
    var dialogComponent = this.data.lastComponent = this.selectComponent('.wxc-online');
    dialogComponent && dialogComponent.show();
  },
  cancel: function cancel() {
    this.data.lastComponent.hide();

    this.setData({
      amount: 0,
      orderType: '',
      orderId: '',
      lastComponent: '',
      formId: '',
      lastIndex: '',
      payType: '',
      beauticianCode: '',
      couponCode: ''
    });
  },

  cancelOrderConfirm: function cancelOrderConfirm() {
    var _this4 = this;

    var app = getApp();
    var formId = this.data.formId;
    var orderId = this.data.orderId;
    var index = this.data.lastIndex;

    app.get('center/cancelOrder/' + orderId, { formId: formId }).then(function (data) {
      var orderList = _this4.data.orderList;
      orderList[index].order_status = 2;
      _this4.cancel();
    }).catch(function (error) {
      wx.showToast({
        title: error.detail
      });
    });
  },
  cancelOrder: function cancelOrder(event) {

    var dialogComponent = this.data.lastComponent = this.selectComponent('.wxc-cancel-order');
    dialogComponent && dialogComponent.show();

    var formId = event.detail.formId;
    var orderId = event.detail.target.dataset.id;
    var index = event.detail.target.dataset.index;
    this.setData({
      formId: formId,
      orderId: orderId,
      lastIndex: index
    });
  },
  _realDay: function _realDay(day, value) {
    try {
      var _day = day + ' ' + value;
      _day = _day.replace(/-/g, '/');
      var date = new Date(_day).getTime() + 30 * 60 * 1000;
      date = new Date(date);
      var minute = date.getMinutes();
      if (minute.toString().length == 1) minute += '0';

      // console.log(value)
      // console.log(day)
      return date.getHours() + ':' + minute + ':00';
    } catch (e) {
      return value;
    }
  }

});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImluZGV4Lnd4cCJdLCJuYW1lcyI6WyJkYXRhIiwiYW1vdW50Iiwib3JkZXJUeXBlIiwib3JkZXJJZCIsImxhc3RDb21wb25lbnQiLCJmb3JtSWQiLCJsYXN0SW5kZXgiLCJvcmRlckxpc3QiLCJwYXlUeXBlIiwiYmVhdXRpY2lhbkNvZGUiLCJjb3Vwb25Db2RlIiwib25Mb2FkIiwib3B0aW9ucyIsIm9uU2hvdyIsImdldE9yZGVyTGlzdCIsImFwcCIsImdldEFwcCIsImdldCIsIm9yZGVyX3N0YXR1cyIsInRoZW4iLCJyZXN1bHQiLCJjb250ZW50IiwiZm9yRWFjaCIsIml0ZW0iLCJhcHBvaW50bWVudF9lbmRfdGltZSIsIl9yZWFsRGF5IiwiYXBwb2ludG1lbnRfZGF5Iiwic2V0RGF0YSIsInBheU9mZmxpbmUiLCJ0cmltIiwibGVuZ3RoIiwid3giLCJzaG93VG9hc3QiLCJ0aXRsZSIsImljb24iLCJtYXRjaCIsInBvc3QiLCJ0eXBlIiwiYmVhdXRpY2lhbl9jb2RlIiwiY291cG9uX2NvZGUiLCJjYW5jZWwiLCJjYXRjaCIsImVycm9yIiwiZGV0YWlsIiwiZHVyYXRpb24iLCJwYXlPbmxpbmUiLCJvcmRlck5vIiwicGF5UGFyYW1zIiwicmVzIiwic2V0VGltZW91dCIsIk9iamVjdCIsImFzc2lnbiIsInJlcXVlc3RQYXltZW50IiwiY2FzaCIsImV2ZW50IiwiaWQiLCJjdXJyZW50VGFyZ2V0IiwiZGF0YXNldCIsImRpYWxvZ0NvbXBvbmVudCIsInNlbGVjdENvbXBvbmVudCIsInNob3ciLCJoYW5kbGVyQmVhdXRpY2lhbiIsInZhbHVlIiwiaGFuZGxlckNvdXBvbkNvZGUiLCJzY2FuIiwiZ3JvdXBCeSIsIm9ubGluZSIsImhpZGUiLCJjYW5jZWxPcmRlckNvbmZpcm0iLCJpbmRleCIsImNhbmNlbE9yZGVyIiwidGFyZ2V0IiwiZGF5IiwiX2RheSIsInJlcGxhY2UiLCJkYXRlIiwiRGF0ZSIsImdldFRpbWUiLCJtaW51dGUiLCJnZXRNaW51dGVzIiwidG9T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Q0FELHVCQUFtQkEsZ0JBQWdCRSxJQUFoQixFQUFuQjs7QUFFQSxRQUFJdkQsU0FBU2lELE1BQU1YLE1BQU4sQ0FBYXRDLE1BQTFCO0FBQ0EsUUFBSUYsVUFBVW1ELE1BQU1YLE1BQU4sQ0FBYTRCLE1BQWIsQ0FBb0JkLE9BQXBCLENBQTRCRixFQUExQztBQUNBLFFBQUljLFFBQVFmLE1BQU1YLE1BQU4sQ0FBYTRCLE1BQWIsQ0FBb0JkLE9BQXBCLENBQTRCWSxLQUF4QztBQUNBLFNBQUsxQyxPQUFMLENBQWE7QUFDWHRCLGNBQVFBLE1BREc7QUFFWEYsZUFBU0EsT0FGRTtBQUdYRyxpQkFBVytEO0FBSEEsS0FBYjtBQUtELEc7QUFDRDVDLFlBQVUsa0JBQVUrQyxHQUFWLEVBQWVWLEtBQWYsRUFBc0I7QUFDOUIsUUFBSTtBQUNGLFVBQUlXLE9BQU9ELE1BQU0sR0FBTixHQUFZVixLQUF2QjtBQUNBVyxhQUFPQSxLQUFLQyxPQUFMLENBQWEsSUFBYixFQUFtQixHQUFuQixDQUFQO0FBQ0EsVUFBSUMsT0FBUSxJQUFJQyxJQUFKLENBQVNILElBQVQsQ0FBRCxDQUFpQkksT0FBakIsS0FBNkIsS0FBSyxFQUFMLEdBQVUsSUFBbEQ7QUFDQUYsYUFBUSxJQUFJQyxJQUFKLENBQVNELElBQVQsQ0FBUjtBQUNBLFVBQUlHLFNBQVNILEtBQUtJLFVBQUwsRUFBYjtBQUNBLFVBQUlELE9BQU9FLFFBQVAsR0FBa0JsRCxNQUFsQixJQUE0QixDQUFoQyxFQUNFZ0QsVUFBVSxHQUFWOztBQUVGO0FBQ0E7QUFDQSxhQUFPSCxLQUFLTSxRQUFMLEtBQWtCLEdBQWxCLEdBQXdCSCxNQUF4QixHQUFpQyxLQUF4QztBQUNELEtBWkQsQ0FZRSxPQUFPSSxDQUFQLEVBQVU7QUFDVixhQUFPcEIsS0FBUDtBQUNEO0FBQ0YiLCJmaWxlIjoiaW5kZXgud3hwIiwic291cmNlc0NvbnRlbnQiOlsiZXhwb3J0IGRlZmF1bHQge1xuICAgIGNvbmZpZzoge1xuICAgICAgbmF2aWdhdGlvbkJhclRpdGxlVGV4dDogJ+S5sOWNlScsXG4gICAgICB1c2luZ0NvbXBvbmVudHM6IHtcbiAgICAgICAgJ3d4Yy1kaWFsb2cnOiAnQG1pbnVpL3d4Yy1kaWFsb2cnLFxuICAgICAgICAnd3hjLWFibm9yJzogJ0BtaW51aS93eGMtYWJub3InXG4gICAgICB9XG4gICAgfSxcbiAgICBkYXRhOiB7XG4gICAgICBhbW91bnQ6IDAsXG4gICAgICBvcmRlclR5cGU6ICcnLFxuICAgICAgb3JkZXJJZDogJycsXG4gICAgICBsYXN0Q29tcG9uZW50OiAnJyxcbiAgICAgIGZvcm1JZDogJycsXG4gICAgICBsYXN0SW5kZXg6ICcnLFxuICAgICAgb3JkZXJMaXN0OiBbXSxcbiAgICAgIHBheVR5cGU6ICcnLFxuICAgICAgYmVhdXRpY2lhbkNvZGU6ICcnLFxuICAgICAgY291cG9uQ29kZTogJydcbiAgICB9LFxuICAgIG9uTG9hZDogZnVuY3Rpb24gKG9wdGlvbnMpIHtcbiAgICAgIC8vIGNvbnNvbGUubG9nKG9wdGlvbnMpXG4gICAgfSxcbiAgICBvblNob3c6IGZ1bmN0aW9uICgpIHtcbiAgICAgIHRoaXMuZ2V0T3JkZXJMaXN0KClcbiAgICB9LFxuICAgIGdldE9yZGVyTGlzdDogZnVuY3Rpb24gKCkge1xuICAgICAgbGV0IGFwcCA9IGdldEFwcCgpXG4gICAgICBhcHAuZ2V0KCdjZW50ZXIvb3JkZXInLCB7b3JkZXJfc3RhdHVzOiAxfSkudGhlbihkYXRhID0+IHtcbiAgICAgICAgbGV0IHJlc3VsdCA9IGRhdGEuZGF0YVxuICAgICAgICByZXN1bHQuY29udGVudC5mb3JFYWNoKGl0ZW0gPT4gaXRlbS5hcHBvaW50bWVudF9lbmRfdGltZSA9IHRoaXMuX3JlYWxEYXkoaXRlbS5hcHBvaW50bWVudF9kYXksIGl0ZW0uYXBwb2ludG1lbnRfZW5kX3RpbWUpKVxuICAgICAgICB0aGlzLnNldERhdGEoe1xuICAgICAgICAgIG9yZGVyTGlzdDogcmVzdWx0LmNvbnRlbnRcbiAgICAgICAgfSlcbiAgICAgIH0pXG4gICAgfSxcbiAgICBwYXlPZmZsaW5lOiBmdW5jdGlvbiAoKSB7XG4gICAgICBsZXQgYXBwID0gZ2V0QXBwKClcbiAgICAgIGlmICh0aGlzLmRhdGEucGF5VHlwZSA9PT0gJ2Nhc2gnKSB7XG4gICAgICAgIGlmICh0aGlzLmRhdGEuYmVhdXRpY2lhbkNvZGUudHJpbSgpLmxlbmd0aCA9PT0gMCkge1xuICAgICAgICAgIHd4LnNob3dUb2FzdCh7XG4gICAgICAgICAgICB0aXRsZTogJ+aKgOW4iOW3peWPt+S4jeiDveS4uuepuicsXG4gICAgICAgICAgICBpY29uOiAnbm9uZSdcbiAgICAgICAgICB9KVxuXG4gICAgICAgICAgcmV0dXJuXG4gICAgICAgIH1cbiAgICAgIH1cblxuICAgICAgLy8g5Zui6LStXG4gICAgICBpZiAodGhpcy5kYXRhLnBheVR5cGUgPT09ICdncm91cCcpIHtcbiAgICAgICAgaWYgKCF0aGlzLmRhdGEuY291cG9uQ29kZS5tYXRjaCgvXlxcZHsxMH0kLykgJiYgIXRoaXMuZGF0YS5jb3Vwb25Db2RlLm1hdGNoKC9eXFxkezEyfSQvKSkge1xuICAgICAgICAgIHd4LnNob3dUb2FzdCh7XG4gICAgICAgICAgICB0aXRsZTogJ+WIuOWPt+i+k+WFpemUmeivryzliLjlj7fkvY3mlbDkuLoxMOS9jeaIluiAhTEy5L2NJyxcbiAgICAgICAgICAgIGljb246ICdub25lJ1xuICAgICAgICAgIH0pXG5cbiAgICAgICAgICByZXR1cm5cbiAgICAgICAgfVxuICAgICAgfVxuXG5cbiAgICAgIGFwcC5wb3N0KGBjZW50ZXIvY29tcGxldGVPcmRlci8ke3RoaXMuZGF0YS5vcmRlcklkfWAsIHtcbiAgICAgICAgdHlwZTogdGhpcy5kYXRhLnBheVR5cGUsXG4gICAgICAgIGJlYXV0aWNpYW5fY29kZTogdGhpcy5kYXRhLmJlYXV0aWNpYW5Db2RlLCBjb3Vwb25fY29kZTogdGhpcy5kYXRhLmNvdXBvbkNvZGVcbiAgICAgIH0pLnRoZW4oKCkgPT4ge1xuICAgICAgICB0aGlzLmdldE9yZGVyTGlzdCgpXG4gICAgICAgIHRoaXMuY2FuY2VsKClcbiAgICAgIH0pXG4gICAgICAgIC5jYXRjaChlcnJvciA9PiB7XG4gICAgICAgICAgd3guc2hvd1RvYXN0KHtcbiAgICAgICAgICAgIHRpdGxlOiBlcnJvci5kZXRhaWwgfHwgJ+aUr+S7mOWksei0pe+8jOivt+mHjeivlScsXG4gICAgICAgICAgICBkdXJhdGlvbjogMjAwMCxcbiAgICAgICAgICAgIGljb246ICdub25lJ1xuICAgICAgICAgIH0pXG4gICAgICAgIH0pXG4gICAgfSxcbiAgICBwYXlPbmxpbmU6IGZ1bmN0aW9uICgpIHtcbiAgICAgIGxldCBhcHAgPSBnZXRBcHAoKVxuICAgICAgYXBwLmdldChgb3JkZXIvcGF5LyR7dGhpcy5kYXRhLm9yZGVyTm99YClcbiAgICAgICAgLnRoZW4oZGF0YSA9PiB7XG4gICAgICAgICAgbGV0IHJlc3VsdCA9IGRhdGEuZGF0YVxuICAgICAgICAgIGxldCBwYXlQYXJhbXMgPSB7XG4gICAgICAgICAgICAnc3VjY2Vzcyc6IGZ1bmN0aW9uIChyZXMpIHtcblxuICAgICAgICAgICAgICB3eC5zaG93VG9hc3Qoe1xuICAgICAgICAgICAgICAgIHRpdGxlOiAn5pSv5LuY5oiQ5YqfLOetieW+heaVsOaNruehruiupO+8jOivt+eojeetiS4uLicsXG4gICAgICAgICAgICAgICAgZHVyYXRpb246IDMwMDAsXG4gICAgICAgICAgICAgICAgaWNvbjogJ25vbmUnXG4gICAgICAgICAgICAgIH0pXG5cbiAgICAgICAgICAgICAgdGhpcy5jYW5jZWwoKVxuXG4gICAgICAgICAgICAgIHNldFRpbWVvdXQoeCA9PiB0aGlzLmdldE9yZGVyTGlzdCgpLCAyMDAwKVxuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICdmYWlsJzogZnVuY3Rpb24gKHJlcykge1xuICAgICAgICAgICAgICB3eC5zaG93VG9hc3Qoe1xuICAgICAgICAgICAgICAgIHRpdGxlOiAn5pSv5LuY5aSx6LSlLCDor7fph43or5UuLi4nLFxuICAgICAgICAgICAgICAgIGR1cmF0aW9uOiAyMDAwLFxuICAgICAgICAgICAgICAgIGljb246ICdub25lJ1xuICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgfVxuICAgICAgICAgIH1cblxuICAgICAgICAgIE9iamVjdC5hc3NpZ24ocGF5UGFyYW1zLCByZXN1bHQuY29udGVudClcblxuICAgICAgICAgIHd4LnJlcXVlc3RQYXltZW50KHBheVBhcmFtcylcbiAgICAgICAgfSlcbiAgICAgICAgLmNhdGNoKGVycm9yID0+IHtcbiAgICAgICAgICB3eC5zaG93VG9hc3Qoe1xuICAgICAgICAgICAgdGl0bGU6IGVycm9yLmRldGFpbCB8fCAn5pSv5LuY5aSx6LSl77yM6K+36YeN6K+VJyxcbiAgICAgICAgICAgIGR1cmF0aW9uOiAyMDAwLFxuICAgICAgICAgICAgaWNvbjogJ25vbmUnXG4gICAgICAgICAgfSlcbiAgICAgICAgfSlcbiAgICB9LFxuICAgIGNhc2g6IGZ1bmN0aW9uIChldmVudCkge1xuICAgICAgbGV0IGlkID0gZXZlbnQuY3VycmVudFRhcmdldC5kYXRhc2V0LmlkXG4gICAgICB0aGlzLnNldERhdGEoe1xuICAgICAgICBwYXlUeXBlOiAnY2FzaCcsXG4gICAgICAgIG9yZGVySWQ6IGlkLFxuICAgICAgfSlcbiAgICAgIGxldCBkaWFsb2dDb21wb25lbnQgPSB0aGlzLmRhdGEubGFzdENvbXBvbmVudCA9IHRoaXMuc2VsZWN0Q29tcG9uZW50KCcud3hjLWNhc2gnKVxuICAgICAgZGlhbG9nQ29tcG9uZW50ICYmIGRpYWxvZ0NvbXBvbmVudC5zaG93KCk7XG4gICAgfSxcbiAgICBoYW5kbGVyQmVhdXRpY2lhbjogZnVuY3Rpb24gKGV2ZW50KSB7XG4gICAgICBsZXQgdmFsdWUgPSBldmVudC5kZXRhaWwudmFsdWVcbiAgICAgIHRoaXMuc2V0RGF0YSh7XG4gICAgICAgIGJlYXV0aWNpYW5Db2RlOiB2YWx1ZVxuICAgICAgfSlcbiAgICB9LFxuICAgIGhhbmRsZXJDb3Vwb25Db2RlOiBmdW5jdGlvbiAoZXZlbnQpIHtcbiAgICAgIGxldCB2YWx1ZSA9IGV2ZW50LmRldGFpbC52YWx1ZVxuICAgICAgdGhpcy5zZXREYXRhKHtcbiAgICAgICAgY291cG9uQ29kZTogdmFsdWVcbiAgICAgIH0pXG4gICAgfSxcbiAgICBzY2FuOiBmdW5jdGlvbiAoZXZlbnQpIHtcbiAgICAgIGxldCBpZCA9IGV2ZW50LmN1cnJlbnRUYXJnZXQuZGF0YXNldC5pZFxuICAgICAgdGhpcy5zZXREYXRhKHtcbiAgICAgICAgcGF5VHlwZTogJ3NjYW4nLFxuICAgICAgICBvcmRlcklkOiBpZFxuICAgICAgfSlcbiAgICAgIGxldCBkaWFsb2dDb21wb25lbnQgPSB0aGlzLmRhdGEubGFzdENvbXBvbmVudCA9IHRoaXMuc2VsZWN0Q29tcG9uZW50KCcud3hjLXNjYW4nKVxuICAgICAgZGlhbG9nQ29tcG9uZW50ICYmIGRpYWxvZ0NvbXBvbmVudC5zaG93KCk7XG4gICAgfSxcbiAgICBncm91cEJ5OiBmdW5jdGlvbiAoZXZlbnQpIHtcbiAgICAgIGxldCBpZCA9IGV2ZW50LmN1cnJlbnRUYXJnZXQuZGF0YXNldC5pZFxuICAgICAgdGhpcy5zZXREYXRhKHtcbiAgICAgICAgcGF5VHlwZTogJ2dyb3VwJyxcbiAgICAgICAgb3JkZXJJZDogaWRcbiAgICAgIH0pXG4gICAgICBsZXQgZGlhbG9nQ29tcG9uZW50ID0gdGhpcy5kYXRhLmxhc3RDb21wb25lbnQgPSB0aGlzLnNlbGVjdENvbXBvbmVudCgnLnd4Yy1ncm91cCcpXG4gICAgICBkaWFsb2dDb21wb25lbnQgJiYgZGlhbG9nQ29tcG9uZW50LnNob3coKTtcbiAgICB9LFxuICAgIG9ubGluZTogZnVuY3Rpb24gKGV2ZW50KSB7XG4gICAgICBsZXQgb3JkZXJObyA9IGV2ZW50LmN1cnJlbnRUYXJnZXQuZGF0YXNldC5pZFxuICAgICAgbGV0IGFtb3VudCA9IGV2ZW50LmN1cnJlbnRUYXJnZXQuZGF0YXNldC5hbW91bnRcbiAgICAgIHRoaXMuc2V0RGF0YSh7XG4gICAgICAgIHBheVR5cGU6ICdvbmxpbmUnLFxuICAgICAgICBvcmRlck5vOiBvcmRlck5vLFxuICAgICAgICBhbW91bnQ6IGFtb3VudCxcbiAgICAgIH0pXG4gICAgICBsZXQgZGlhbG9nQ29tcG9uZW50ID0gdGhpcy5kYXRhLmxhc3RDb21wb25lbnQgPSB0aGlzLnNlbGVjdENvbXBvbmVudCgnLnd4Yy1vbmxpbmUnKVxuICAgICAgZGlhbG9nQ29tcG9uZW50ICYmIGRpYWxvZ0NvbXBvbmVudC5zaG93KCk7XG4gICAgfSxcbiAgICBjYW5jZWw6IGZ1bmN0aW9uICgpIHtcbiAgICAgIHRoaXMuZGF0YS5sYXN0Q29tcG9uZW50LmhpZGUoKTtcblxuICAgICAgdGhpcy5zZXREYXRhKHtcbiAgICAgICAgYW1vdW50OiAwLFxuICAgICAgICBvcmRlclR5cGU6ICcnLFxuICAgICAgICBvcmRlcklkOiAnJyxcbiAgICAgICAgbGFzdENvbXBvbmVudDogJycsXG4gICAgICAgIGZvcm1JZDogJycsXG4gICAgICAgIGxhc3RJbmRleDogJycsXG4gICAgICAgIHBheVR5cGU6ICcnLFxuICAgICAgICBiZWF1dGljaWFuQ29kZTogJycsXG4gICAgICAgIGNvdXBvbkNvZGU6ICcnXG4gICAgICB9KVxuICAgIH0sXG5cbiAgICBjYW5jZWxPcmRlckNvbmZpcm06IGZ1bmN0aW9uICgpIHtcbiAgICAgIGxldCBhcHAgPSBnZXRBcHAoKVxuICAgICAgbGV0IGZvcm1JZCA9IHRoaXMuZGF0YS5mb3JtSWRcbiAgICAgIGxldCBvcmRlcklkID0gdGhpcy5kYXRhLm9yZGVySWRcbiAgICAgIGxldCBpbmRleCA9IHRoaXMuZGF0YS5sYXN0SW5kZXhcblxuICAgICAgYXBwLmdldCgnY2VudGVyL2NhbmNlbE9yZGVyLycgKyBvcmRlcklkLCB7Zm9ybUlkOiBmb3JtSWR9KVxuICAgICAgICAudGhlbihkYXRhID0+IHtcbiAgICAgICAgICBsZXQgb3JkZXJMaXN0ID0gdGhpcy5kYXRhLm9yZGVyTGlzdFxuICAgICAgICAgIG9yZGVyTGlzdFtpbmRleF0ub3JkZXJfc3RhdHVzID0gMlxuICAgICAgICAgIHRoaXMuY2FuY2VsKClcbiAgICAgICAgfSlcbiAgICAgICAgLmNhdGNoKGVycm9yID0+IHtcbiAgICAgICAgICB3eC5zaG93VG9hc3Qoe1xuICAgICAgICAgICAgdGl0bGU6IGVycm9yLmRldGFpbFxuICAgICAgICAgIH0pXG4gICAgICAgIH0pXG4gICAgfSxcbiAgICBjYW5jZWxPcmRlcjogZnVuY3Rpb24gKGV2ZW50KSB7XG5cbiAgICAgIGxldCBkaWFsb2dDb21wb25lbnQgPSB0aGlzLmRhdGEubGFzdENvbXBvbmVudCA9IHRoaXMuc2VsZWN0Q29tcG9uZW50KCcud3hjLWNhbmNlbC1vcmRlcicpXG4gICAgICBkaWFsb2dDb21wb25lbnQgJiYgZGlhbG9nQ29tcG9uZW50LnNob3coKTtcblxuICAgICAgbGV0IGZvcm1JZCA9IGV2ZW50LmRldGFpbC5mb3JtSWRcbiAgICAgIGxldCBvcmRlcklkID0gZXZlbnQuZGV0YWlsLnRhcmdldC5kYXRhc2V0LmlkXG4gICAgICBsZXQgaW5kZXggPSBldmVudC5kZXRhaWwudGFyZ2V0LmRhdGFzZXQuaW5kZXhcbiAgICAgIHRoaXMuc2V0RGF0YSh7XG4gICAgICAgIGZvcm1JZDogZm9ybUlkLFxuICAgICAgICBvcmRlcklkOiBvcmRlcklkLFxuICAgICAgICBsYXN0SW5kZXg6IGluZGV4XG4gICAgICB9KVxuICAgIH0sXG4gICAgX3JlYWxEYXk6IGZ1bmN0aW9uIChkYXksIHZhbHVlKSB7XG4gICAgICB0cnkge1xuICAgICAgICB2YXIgX2RheSA9IGRheSArICcgJyArIHZhbHVlXG4gICAgICAgIF9kYXkgPSBfZGF5LnJlcGxhY2UoLy0vZywgJy8nKVxuICAgICAgICBsZXQgZGF0ZSA9IChuZXcgRGF0ZShfZGF5KSkuZ2V0VGltZSgpICsgMzAgKiA2MCAqIDEwMDBcbiAgICAgICAgZGF0ZSA9IChuZXcgRGF0ZShkYXRlKSlcbiAgICAgICAgbGV0IG1pbnV0ZSA9IGRhdGUuZ2V0TWludXRlcygpXG4gICAgICAgIGlmIChtaW51dGUudG9TdHJpbmcoKS5sZW5ndGggPT0gMSlcbiAgICAgICAgICBtaW51dGUgKz0gJzAnXG5cbiAgICAgICAgLy8gY29uc29sZS5sb2codmFsdWUpXG4gICAgICAgIC8vIGNvbnNvbGUubG9nKGRheSlcbiAgICAgICAgcmV0dXJuIGRhdGUuZ2V0SG91cnMoKSArICc6JyArIG1pbnV0ZSArICc6MDAnXG4gICAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgIHJldHVybiB2YWx1ZVxuICAgICAgfVxuICAgIH1cblxuICB9Il19