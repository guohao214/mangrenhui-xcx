'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = Page({
  data: {
    '__code__': {
      readme: ''
    },

    accountAmount: 0, // 账户余额
    amount: 0,
    orderType: '',
    orderId: '',
    lastComponent: '',
    formId: '',
    lastIndex: '',
    orderList: [],
    payType: '',
    beauticianCode: '',
    couponCode: ''
  },
  onLoad: function onLoad(options) {
    // console.log(options)
  },
  onShow: function onShow() {
    this.getOrderList();
  },
  getOrderList: function getOrderList() {
    var _this = this;

    var app = getApp();
    app.get('center/order', { order_status: 1 }).then(function (data) {
      var result = data.data;
      result.content.forEach(function (item) {
        return item.appointment_end_time = _this._realDay(item.appointment_day, item.appointment_end_time);
      });
      _this.setData({
        orderList: result.content
      });
    });
  },
  payOffline: function payOffline() {
    var _this2 = this;

    var app = getApp();
    if (this.data.payType === 'cash') {
      if (this.data.beauticianCode.trim().length === 0) {
        wx.showToast({
          title: '管家工号不能为空',
          icon: 'none'
        });

        return;
      }
    }

    // 团购
    if (this.data.payType === 'group') {
      if (!this.data.couponCode.match(/^\d{10}$/) && !this.data.couponCode.match(/^\d{12}$/)) {
        wx.showToast({
          title: '券号输入错误,券号位数为10位或者12位',
          icon: 'none'
        });

        return;
      }
    }

    app.post('center/completeOrder/' + this.data.orderId, {
      type: this.data.payType,
      beautician_code: this.data.beauticianCode, coupon_code: this.data.couponCode
    }).then(function () {
      _this2.getOrderList();
      _this2.cancel();
    }).catch(function (error) {
      wx.showToast({
        title: error.detail || '支付失败，请重试',
        duration: 2000,
        icon: 'none'
      });
    });
  },

  payOnline: function payOnline() {
    var _this3 = this;

    var app = getApp();
    app.get('order/pay/' + this.data.orderNo).then(function (data) {
      var result = data.data;
      var self = _this3;
      var payParams = {
        'success': function success(res) {

          wx.showToast({
            title: '支付成功,等待数据确认，请稍等...',
            duration: 3000,
            icon: 'none'
          });

          self.cancel();

          setTimeout(function (x) {
            return self.getOrderList();
          }, 2000);
        },
        'fail': function fail(res) {
          // wx.showToast({
          //   title: '支付失败, 请重试...',
          //   duration: 2000,
          //   icon: 'none'
          // })
        }
      };

      Object.assign(payParams, result.content);

      wx.requestPayment(payParams);
    }).catch(function (error) {
      wx.showToast({
        title: error.detail || '支付失败，请重试',
        duration: 2000,
        icon: 'none'
      });
    });
  },

  // 余额支付
  payRecharge: function payRecharge() {
    var app = getApp();
    var self = this;

    app.get('RechargeCard/rechargePayment/' + this.data.orderNo).then(function (data) {
      wx.showToast({
        title: '支付成功,等待数据确认，请稍等...',
        duration: 3000,
        icon: 'none'
      });

      self.cancel();

      setTimeout(function (x) {
        return self.getOrderList();
      }, 2000);
    }).catch(function (error) {
      wx.showToast({
        title: error.detail || '支付失败，请重试',
        duration: 2000,
        icon: 'none'
      });
    });
  },


  cash: function cash(event) {
    var id = event.currentTarget.dataset.id;
    this.setData({
      payType: 'cash',
      orderId: id
    });
    var dialogComponent = this.data.lastComponent = this.selectComponent('.wxc-cash');
    dialogComponent && dialogComponent.show();
  },
  handlerBeautician: function handlerBeautician(event) {
    var value = event.detail.value;
    this.setData({
      beauticianCode: value
    });
  },
  handlerCouponCode: function handlerCouponCode(event) {
    var value = event.detail.value;
    this.setData({
      couponCode: value
    });
  },

  scan: function scan(event) {
    var id = event.currentTarget.dataset.id;
    this.setData({
      payType: 'scan',
      orderId: id
    });
    var dialogComponent = this.data.lastComponent = this.selectComponent('.wxc-scan');
    dialogComponent && dialogComponent.show();
  },
  groupBy: function groupBy(event) {
    var id = event.currentTarget.dataset.id;
    this.setData({
      payType: 'group',
      orderId: id
    });
    var dialogComponent = this.data.lastComponent = this.selectComponent('.wxc-group');
    dialogComponent && dialogComponent.show();
  },

  // 在线支付
  online: function online(event) {
    var orderNo = event.currentTarget.dataset.id;
    var amount = event.currentTarget.dataset.amount / 1;
    this.setData({
      payType: 'online',
      orderNo: orderNo,
      amount: amount
    });
    var dialogComponent = this.data.lastComponent = this.selectComponent('.wxc-online');
    dialogComponent && dialogComponent.show();
  },

  // 余额支付弹窗
  rechargePayment: function rechargePayment(event) {
    var _this4 = this;

    // 查询账户余额
    var app = getApp();
    var orderNo = event.currentTarget.dataset.id;
    var amount = event.currentTarget.dataset.amount / 1;

    app.get('rechargeCard/getMyRechargeCardTotalAmount/' + orderNo).then(function (data) {
      var accountAmount = data.data.content.amount;
      var realPaymentAmount = data.data.content.real_pay_amount;
      if (accountAmount <= 0) {
        return wx.message('账户余额为0，不能支付');
      }

      if (amount > accountAmount) {
        return wx.message('\u8D26\u6237\u4F59\u989D\u4E3A:\uFFE5' + accountAmount + '\uFF0C\u4F59\u989D\u4E0D\u8DB3\uFF0C\u4E0D\u80FD\u652F\u4ED8');
      }

      _this4.setData({
        accountAmount: accountAmount
      }, function () {
        _this4.setData({
          payType: 'recharge',
          orderNo: orderNo,
          amount: realPaymentAmount
        });

        var dialogComponent = _this4.data.lastComponent = _this4.selectComponent('.wxc-recharge');
        dialogComponent && dialogComponent.show();
      });
    });
  },

  cancel: function cancel() {
    this.data.lastComponent.hide();

    this.setData({
      amount: 0,
      orderType: '',
      orderId: '',
      lastComponent: '',
      formId: '',
      lastIndex: '',
      payType: '',
      beauticianCode: '',
      couponCode: ''
    });
  },

  cancelOrderConfirm: function cancelOrderConfirm() {
    var _this5 = this;

    var app = getApp();
    var formId = this.data.formId;
    var orderId = this.data.orderId;
    var index = this.data.lastIndex;

    app.get('center/cancelOrder/' + orderId, { formId: formId }).then(function (data) {
      var orderList = _this5.data.orderList;
      orderList[index].order_status = 2;
      _this5.cancel();
    }).catch(function (error) {
      wx.showToast({
        title: error.detail
      });
    });
  },
  cancelOrder: function cancelOrder(event) {

    var dialogComponent = this.data.lastComponent = this.selectComponent('.wxc-cancel-order');
    dialogComponent && dialogComponent.show();

    var formId = event.detail.formId;
    var orderId = event.detail.target.dataset.id;
    var index = event.detail.target.dataset.index;
    this.setData({
      formId: formId,
      orderId: orderId,
      lastIndex: index
    });
  },
  _realDay: function _realDay(day, value) {
    try {
      var _day = day + ' ' + value;
      _day = _day.replace(/-/g, '/');
      var date = new Date(_day).getTime() + 30 * 60 * 1000;
      date = new Date(date);
      var minute = date.getMinutes();
      if (minute.toString().length == 1) minute += '0';

      // console.log(value)
      // console.log(day)
      return date.getHours() + ':' + minute + ':00';
    } catch (e) {
      return value;
    }
  }

});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImluZGV4Lnd4cCJdLCJuYW1lcyI6WyJkYXRhIiwiYWNjb3VudEFtb3VudCIsImFtb3VudCIsIm9yZGVyVHlwZSIsIm9yZGVySWQiLCJsYXN0Q29tcG9uZW50IiwiZm9ybUlkIiwibGFzdEluZGV4Iiwib3JkZXJMaXN0IiwicGF5VHlwZSIsImJlYXV0aWNpYW5Db2RlIiwiY291cG9uQ29kZSIsIm9uTG9hZCIsIm9wdGlvbnMiLCJvblNob3ciLCJnZXRPcmRlckxpc3QiLCJhcHAiLCJnZXRBcHAiLCJnZXQiLCJvcmRlcl9zdGF0dXMiLCJ0aGVuIiwicmVzdWx0IiwiY29udGVudCIsImZvckVhY2giLCJpdGVtIiwiYXBwb2ludG1lbnRfZW5kX3RpbWUiLCJfcmVhbERheSIsImFwcG9pbnRtZW50X2RheSIsInNldERhdGEiLCJwYXlPZmZsaW5lIiwidHJpbSIsImxlbmd0aCIsInd4Iiwic2hvd1RvYXN0IiwidGl0bGUiLCJpY29uIiwibWF0Y2giLCJwb3N0IiwidHlwZSIsImJlYXV0aWNpYW5fY29kZSIsImNvdXBvbl9jb2RlIiwiY2FuY2VsIiwiY2F0Y2giLCJlcnJvciIsImRldGFpbCIsImR1cmF0aW9uIiwicGF5T25saW5lIiwib3JkZXJObyIsInNlbGYiLCJwYXlQYXJhbXMiLCJyZXMiLCJzZXRUaW1lb3V0IiwiT2JqZWN0IiwiYXNzaWduIiwicmVxdWVzdFBheW1lbnQiLCJwYXlSZWNoYXJnZSIsImNhc2giLCJldmVudCIsImlkIiwiY3VycmVudFRhcmdldCIsImRhdGFzZXQiLCJkaWFsb2dDb21wb25lbnQiLCJzZWxlY3RDb21wb25lbnQiLCJzaG93IiwiaGFuZGxlckJlYXV0aWNpYW4iLCJ2YWx1ZSIsImhhbmRsZXJDb3Vwb25Db2RlIiwic2NhbiIsImdyb3VwQnkiLCJvbmxpbmUiLCJyZWNoYXJnZVBheW1lbnQiLCJyZWFsUGF5bWVudEFtb3VudCIsInJlYWxfcGF5X2Ftb3VudCIsIm1lc3NhZ2UiLCJoaWRlIiwiY2FuY2VsT3JkZXJDb25maXJtIiwiaW5kZXgiLCJjYW5jZWxPcmRlciIsInRhcmdldCIsImRheSIsIl9kYXkiLCJyZXBsYWNlIiwiZGF0ZSIsIkRhdGUiLCJnZXRUaW1lIiwibWludXRlIiwiZ2V0TWludXRlcyIsInRvU3RyaW5nIiwiZ2V0SG91cnMiLCJlIl0sIm1hcHBpbmdzIjoiOzs7Ozs7QUFXSUEsUUFBTTtBQUFBO0FBQUE7QUFBQTs7QUFDSkMsbUJBQWUsQ0FEWCxFQUNjO0FBQ2xCQyxZQUFRLENBRko7QUFHSkMsZUFBVyxFQUhQO0FBSUpDLGFBQVMsRUFKTDtBQUtKQyxtQkFBZSxFQUxYO0FBTUpDLFlBQVEsRUFOSjtBQU9KQyxlQUFXLEVBUFA7QUFRSkMsZUFBVyxFQVJQO0FBU0pDLGFBQVMsRUFUTDtBQVVKQyxvQkFBZ0IsRUFWWjtBQVdKQyxnQkFBWTtBQVhSLEc7QUFhTkMsVUFBUSxnQkFBVUMsT0FBVixFQUFtQjtBQUN6QjtBQUNELEc7QUFDREMsVUFBUSxrQkFBWTtBQUNsQixTQUFLQyxZQUFMO0FBQ0QsRztBQUNEQSxnQkFBYyx3QkFBWTtBQUFBOztBQUN4QixRQUFJQyxNQUFNQyxRQUFWO0FBQ0FELFFBQUlFLEdBQUosQ0FBUSxjQUFSLEVBQXdCLEVBQUNDLGNBQWMsQ0FBZixFQUF4QixFQUEyQ0MsSUFBM0MsQ0FBZ0QsZ0JBQVE7QUFDdEQsVUFBSUMsU0FBU3JCLEtBQUtBLElBQWxCO0FBQ0FxQixhQUFPQyxPQUFQLENBQWVDLE9BQWYsQ0FBdUI7QUFBQSxlQUFRQyxLQUFLQyxvQkFBTCxHQUE0QixNQUFLQyxRQUFMLENBQWNGLEtBQUtHLGVBQW5CLEVBQW9DSCxLQUFLQyxvQkFBekMsQ0FBcEM7QUFBQSxPQUF2QjtBQUNBLFlBQUtHLE9BQUwsQ0FBYTtBQUNYcEIsbUJBQVdhLE9BQU9DO0FBRFAsT0FBYjtBQUdELEtBTkQ7QUFPRCxHO0FBQ0RPLGNBQVksc0JBQVk7QUFBQTs7QUFDdEIsUUFBSWIsTUFBTUMsUUFBVjtBQUNBLFFBQUksS0FBS2pCLElBQUwsQ0FBVVMsT0FBVixLQUFzQixNQUExQixFQUFrQztBQUNoQyxVQUFJLEtBQUtULElBQUwsQ0FBVVUsY0FBVixDQUF5Qm9CLElBQXpCLEdBQWdDQyxNQUFoQyxLQUEyQyxDQUEvQyxFQUFrRDtBQUNoREMsV0FBR0MsU0FBSCxDQUFhO0FBQ1hDLGlCQUFPLFVBREk7QUFFWEMsZ0JBQU07QUFGSyxTQUFiOztBQUtBO0FBQ0Q7QUFDRjs7QUFFRDtBQUNBLFFBQUksS0FBS25DLElBQUwsQ0FBVVMsT0FBVixLQUFzQixPQUExQixFQUFtQztBQUNqQyxVQUFJLENBQUMsS0FBS1QsSUFBTCxDQUFVVyxVQUFWLENBQXFCeUIsS0FBckIsQ0FBMkIsVUFBM0IsQ0FBRCxJQUEyQyxDQUFDLEtBQUtwQyxJQUFMLENBQVVXLFVBQVYsQ0FBcUJ5QixLQUFyQixDQUEyQixVQUEzQixDQUFoRCxFQUF3RjtBQUN0RkosV0FBR0MsU0FBSCxDQUFhO0FBQ1hDLGlCQUFPLHNCQURJO0FBRVhDLGdCQUFNO0FBRkssU0FBYjs7QUFLQTtBQUNEO0FBQ0Y7O0FBR0RuQixRQUFJcUIsSUFBSiwyQkFBaUMsS0FBS3JDLElBQUwsQ0FBVUksT0FBM0MsRUFBc0Q7QUFDcERrQyxZQUFNLEtBQUt0QyxJQUFMLENBQVVTLE9BRG9DO0FBRXBEOEIsdUJBQWlCLEtBQUt2QyxJQUFMLENBQVVVLGNBRnlCLEVBRVQ4QixhQUFhLEtBQUt4QyxJQUFMLENBQVVXO0FBRmQsS0FBdEQsRUFHR1MsSUFISCxDQUdRLFlBQU07QUFDWixhQUFLTCxZQUFMO0FBQ0EsYUFBSzBCLE1BQUw7QUFDRCxLQU5ELEVBT0dDLEtBUEgsQ0FPUyxpQkFBUztBQUNkVixTQUFHQyxTQUFILENBQWE7QUFDWEMsZUFBT1MsTUFBTUMsTUFBTixJQUFnQixVQURaO0FBRVhDLGtCQUFVLElBRkM7QUFHWFYsY0FBTTtBQUhLLE9BQWI7QUFLRCxLQWJIO0FBY0QsRzs7QUFFRFcsYUFBVyxxQkFBWTtBQUFBOztBQUNyQixRQUFJOUIsTUFBTUMsUUFBVjtBQUNBRCxRQUFJRSxHQUFKLGdCQUFxQixLQUFLbEIsSUFBTCxDQUFVK0MsT0FBL0IsRUFDRzNCLElBREgsQ0FDUSxnQkFBUTtBQUNaLFVBQUlDLFNBQVNyQixLQUFLQSxJQUFsQjtBQUNBLFVBQUlnRCxhQUFKO0FBQ0EsVUFBSUMsWUFBWTtBQUNkLG1CQUFXLGlCQUFVQyxHQUFWLEVBQWU7O0FBRXhCbEIsYUFBR0MsU0FBSCxDQUFhO0FBQ1hDLG1CQUFPLG9CQURJO0FBRVhXLHNCQUFVLElBRkM7QUFHWFYsa0JBQU07QUFISyxXQUFiOztBQU1BYSxlQUFLUCxNQUFMOztBQUVBVSxxQkFBVztBQUFBLG1CQUFLSCxLQUFLakMsWUFBTCxFQUFMO0FBQUEsV0FBWCxFQUFxQyxJQUFyQztBQUNELFNBWmE7QUFhZCxnQkFBUSxjQUFVbUMsR0FBVixFQUFlO0FBQ3JCO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDRDtBQW5CYSxPQUFoQjs7QUFzQkFFLGFBQU9DLE1BQVAsQ0FBY0osU0FBZCxFQUF5QjVCLE9BQU9DLE9BQWhDOztBQUVBVSxTQUFHc0IsY0FBSCxDQUFrQkwsU0FBbEI7QUFDRCxLQTdCSCxFQThCR1AsS0E5QkgsQ0E4QlMsaUJBQVM7QUFDZFYsU0FBR0MsU0FBSCxDQUFhO0FBQ1hDLGVBQU9TLE1BQU1DLE1BQU4sSUFBZ0IsVUFEWjtBQUVYQyxrQkFBVSxJQUZDO0FBR1hWLGNBQU07QUFISyxPQUFiO0FBS0QsS0FwQ0g7QUFxQ0QsRzs7QUFFRDtBQUNBb0IsYSx5QkFBYztBQUNaLFFBQUl2QyxNQUFNQyxRQUFWO0FBQ0EsUUFBTStCLE9BQU8sSUFBYjs7QUFFQWhDLFFBQUlFLEdBQUosbUNBQXdDLEtBQUtsQixJQUFMLENBQVUrQyxPQUFsRCxFQUNHM0IsSUFESCxDQUNRLGdCQUFRO0FBQ1pZLFNBQUdDLFNBQUgsQ0FBYTtBQUNQQyxlQUFPLG9CQURBO0FBRVBXLGtCQUFVLElBRkg7QUFHUFYsY0FBTTtBQUhDLE9BQWI7O0FBTUlhLFdBQUtQLE1BQUw7O0FBRUFVLGlCQUFXO0FBQUEsZUFBS0gsS0FBS2pDLFlBQUwsRUFBTDtBQUFBLE9BQVgsRUFBcUMsSUFBckM7QUFDTCxLQVhILEVBWUcyQixLQVpILENBWVMsaUJBQVM7QUFDZFYsU0FBR0MsU0FBSCxDQUFhO0FBQ1hDLGVBQU9TLE1BQU1DLE1BQU4sSUFBZ0IsVUFEWjtBQUVYQyxrQkFBVSxJQUZDO0FBR1hWLGNBQU07QUFISyxPQUFiO0FBS0QsS0FsQkg7QUFtQkQsRzs7O0FBR0RxQixRQUFNLGNBQVVDLEtBQVYsRUFBaUI7QUFDckIsUUFBSUMsS0FBS0QsTUFBTUUsYUFBTixDQUFvQkMsT0FBcEIsQ0FBNEJGLEVBQXJDO0FBQ0EsU0FBSzlCLE9BQUwsQ0FBYTtBQUNYbkIsZUFBUyxNQURFO0FBRVhMLGVBQVNzRDtBQUZFLEtBQWI7QUFJQSxRQUFJRyxrQkFBa0IsS0FBSzdELElBQUwsQ0FBVUssYUFBVixHQUEwQixLQUFLeUQsZUFBTCxDQUFxQixXQUFyQixDQUFoRDtBQUNBRCx1QkFBbUJBLGdCQUFnQkUsSUFBaEIsRUFBbkI7QUFDRCxHO0FBQ0RDLHFCQUFtQiwyQkFBVVAsS0FBVixFQUFpQjtBQUNsQyxRQUFJUSxRQUFRUixNQUFNYixNQUFOLENBQWFxQixLQUF6QjtBQUNBLFNBQUtyQyxPQUFMLENBQWE7QUFDWGxCLHNCQUFnQnVEO0FBREwsS0FBYjtBQUdELEc7QUFDREMscUJBQW1CLDJCQUFVVCxLQUFWLEVBQWlCO0FBQ2xDLFFBQUlRLFFBQVFSLE1BQU1iLE1BQU4sQ0FBYXFCLEtBQXpCO0FBQ0EsU0FBS3JDLE9BQUwsQ0FBYTtBQUNYakIsa0JBQVlzRDtBQURELEtBQWI7QUFHRCxHOztBQUVERSxRQUFNLGNBQVVWLEtBQVYsRUFBaUI7QUFDckIsUUFBSUMsS0FBS0QsTUFBTUUsYUFBTixDQUFvQkMsT0FBcEIsQ0FBNEJGLEVBQXJDO0FBQ0EsU0FBSzlCLE9BQUwsQ0FBYTtBQUNYbkIsZUFBUyxNQURFO0FBRVhMLGVBQVNzRDtBQUZFLEtBQWI7QUFJQSxRQUFJRyxrQkFBa0IsS0FBSzdELElBQUwsQ0FBVUssYUFBVixHQUEwQixLQUFLeUQsZUFBTCxDQUFxQixXQUFyQixDQUFoRDtBQUNBRCx1QkFBbUJBLGdCQUFnQkUsSUFBaEIsRUFBbkI7QUFDRCxHO0FBQ0RLLFdBQVMsaUJBQVVYLEtBQVYsRUFBaUI7QUFDeEIsUUFBSUMsS0FBS0QsTUFBTUUsYUFBTixDQUFvQkMsT0FBcEIsQ0FBNEJGLEVBQXJDO0FBQ0EsU0FBSzlCLE9BQUwsQ0FBYTtBQUNYbkIsZUFBUyxPQURFO0FBRVhMLGVBQVNzRDtBQUZFLEtBQWI7QUFJQSxRQUFJRyxrQkFBa0IsS0FBSzdELElBQUwsQ0FBVUssYUFBVixHQUEwQixLQUFLeUQsZUFBTCxDQUFxQixZQUFyQixDQUFoRDtBQUNBRCx1QkFBbUJBLGdCQUFnQkUsSUFBaEIsRUFBbkI7QUFDRCxHOztBQUVEO0FBQ0FNLFVBQVEsZ0JBQVVaLEtBQVYsRUFBaUI7QUFDdkIsUUFBSVYsVUFBVVUsTUFBTUUsYUFBTixDQUFvQkMsT0FBcEIsQ0FBNEJGLEVBQTFDO0FBQ0EsUUFBSXhELFNBQVN1RCxNQUFNRSxhQUFOLENBQW9CQyxPQUFwQixDQUE0QjFELE1BQTVCLEdBQXFDLENBQWxEO0FBQ0EsU0FBSzBCLE9BQUwsQ0FBYTtBQUNYbkIsZUFBUyxRQURFO0FBRVhzQyxlQUFTQSxPQUZFO0FBR1g3QyxjQUFRQTtBQUhHLEtBQWI7QUFLQSxRQUFJMkQsa0JBQWtCLEtBQUs3RCxJQUFMLENBQVVLLGFBQVYsR0FBMEIsS0FBS3lELGVBQUwsQ0FBcUIsYUFBckIsQ0FBaEQ7QUFDQUQsdUJBQW1CQSxnQkFBZ0JFLElBQWhCLEVBQW5CO0FBQ0QsRzs7QUFFRDtBQUNBTyxtQkFBaUIseUJBQVViLEtBQVYsRUFBaUI7QUFBQTs7QUFDaEM7QUFDQSxRQUFJekMsTUFBTUMsUUFBVjtBQUNBLFFBQUk4QixVQUFVVSxNQUFNRSxhQUFOLENBQW9CQyxPQUFwQixDQUE0QkYsRUFBMUM7QUFDQSxRQUFJeEQsU0FBU3VELE1BQU1FLGFBQU4sQ0FBb0JDLE9BQXBCLENBQTRCMUQsTUFBNUIsR0FBcUMsQ0FBbEQ7O0FBRUFjLFFBQUlFLEdBQUosZ0RBQXFENkIsT0FBckQsRUFBZ0UzQixJQUFoRSxDQUFxRSxnQkFBUTtBQUMzRSxVQUFNbkIsZ0JBQWdCRCxLQUFLQSxJQUFMLENBQVVzQixPQUFWLENBQWtCcEIsTUFBeEM7QUFDQSxVQUFNcUUsb0JBQW9CdkUsS0FBS0EsSUFBTCxDQUFVc0IsT0FBVixDQUFrQmtELGVBQTVDO0FBQ0EsVUFBSXZFLGlCQUFpQixDQUFyQixFQUF3QjtBQUN0QixlQUFPK0IsR0FBR3lDLE9BQUgsQ0FBVyxhQUFYLENBQVA7QUFDRDs7QUFFRCxVQUFJdkUsU0FBU0QsYUFBYixFQUE0QjtBQUMxQixlQUFPK0IsR0FBR3lDLE9BQUgsMkNBQXFCeEUsYUFBckIsa0VBQVA7QUFDRDs7QUFFRCxhQUFLMkIsT0FBTCxDQUFhO0FBQ1gzQjtBQURXLE9BQWIsRUFFRyxZQUFNO0FBQ1AsZUFBSzJCLE9BQUwsQ0FBYTtBQUNYbkIsbUJBQVMsVUFERTtBQUVYc0MsbUJBQVNBLE9BRkU7QUFHWDdDLGtCQUFRcUU7QUFIRyxTQUFiOztBQU1BLFlBQUlWLGtCQUFrQixPQUFLN0QsSUFBTCxDQUFVSyxhQUFWLEdBQTBCLE9BQUt5RCxlQUFMLENBQXFCLGVBQXJCLENBQWhEO0FBQ0FELDJCQUFtQkEsZ0JBQWdCRSxJQUFoQixFQUFuQjtBQUNELE9BWEQ7QUFZRCxLQXZCRDtBQXlCRCxHOztBQUdEdEIsVUFBUSxrQkFBWTtBQUNsQixTQUFLekMsSUFBTCxDQUFVSyxhQUFWLENBQXdCcUUsSUFBeEI7O0FBRUEsU0FBSzlDLE9BQUwsQ0FBYTtBQUNYMUIsY0FBUSxDQURHO0FBRVhDLGlCQUFXLEVBRkE7QUFHWEMsZUFBUyxFQUhFO0FBSVhDLHFCQUFlLEVBSko7QUFLWEMsY0FBUSxFQUxHO0FBTVhDLGlCQUFXLEVBTkE7QUFPWEUsZUFBUyxFQVBFO0FBUVhDLHNCQUFnQixFQVJMO0FBU1hDLGtCQUFZO0FBVEQsS0FBYjtBQVdELEc7O0FBRURnRSxzQkFBb0IsOEJBQVk7QUFBQTs7QUFDOUIsUUFBSTNELE1BQU1DLFFBQVY7QUFDQSxRQUFJWCxTQUFTLEtBQUtOLElBQUwsQ0FBVU0sTUFBdkI7QUFDQSxRQUFJRixVQUFVLEtBQUtKLElBQUwsQ0FBVUksT0FBeEI7QUFDQSxRQUFJd0UsUUFBUSxLQUFLNUUsSUFBTCxDQUFVTyxTQUF0Qjs7QUFFQVMsUUFBSUUsR0FBSixDQUFRLHdCQUF3QmQsT0FBaEMsRUFBeUMsRUFBQ0UsUUFBUUEsTUFBVCxFQUF6QyxFQUNHYyxJQURILENBQ1EsZ0JBQVE7QUFDWixVQUFJWixZQUFZLE9BQUtSLElBQUwsQ0FBVVEsU0FBMUI7QUFDQUEsZ0JBQVVvRSxLQUFWLEVBQWlCekQsWUFBakIsR0FBZ0MsQ0FBaEM7QUFDQSxhQUFLc0IsTUFBTDtBQUNELEtBTEgsRUFNR0MsS0FOSCxDQU1TLGlCQUFTO0FBQ2RWLFNBQUdDLFNBQUgsQ0FBYTtBQUNYQyxlQUFPUyxNQUFNQztBQURGLE9BQWI7QUFHRCxLQVZIO0FBV0QsRztBQUNEaUMsZUFBYSxxQkFBVXBCLEtBQVYsRUFBaUI7O0FBRTVCLFFBQUlJLGtCQUFrQixLQUFLN0QsSUFBTCxDQUFVSyxhQUFWLEdBQTBCLEtBQUt5RCxlQUFMLENBQXFCLG1CQUFyQixDQUFoRDtBQUNBRCx1QkFBbUJBLGdCQUFnQkUsSUFBaEIsRUFBbkI7O0FBRUEsUUFBSXpELFNBQVNtRCxNQUFNYixNQUFOLENBQWF0QyxNQUExQjtBQUNBLFFBQUlGLFVBQVVxRCxNQUFNYixNQUFOLENBQWFrQyxNQUFiLENBQW9CbEIsT0FBcEIsQ0FBNEJGLEVBQTFDO0FBQ0EsUUFBSWtCLFFBQVFuQixNQUFNYixNQUFOLENBQWFrQyxNQUFiLENBQW9CbEIsT0FBcEIsQ0FBNEJnQixLQUF4QztBQUNBLFNBQUtoRCxPQUFMLENBQWE7QUFDWHRCLGNBQVFBLE1BREc7QUFFWEYsZUFBU0EsT0FGRTtBQUdYRyxpQkFBV3FFO0FBSEEsS0FBYjtBQUtELEc7QUFDRGxELFlBQVUsa0JBQVVxRCxHQUFWLEVBQWVkLEtBQWYsRUFBc0I7QUFDOUIsUUFBSTtBQUNGLFVBQUllLE9BQU9ELE1BQU0sR0FBTixHQUFZZCxLQUF2QjtBQUNBZSxhQUFPQSxLQUFLQyxPQUFMLENBQWEsSUFBYixFQUFtQixHQUFuQixDQUFQO0FBQ0EsVUFBSUMsT0FBUSxJQUFJQyxJQUFKLENBQVNILElBQVQsQ0FBRCxDQUFpQkksT0FBakIsS0FBNkIsS0FBSyxFQUFMLEdBQVUsSUFBbEQ7QUFDQUYsYUFBUSxJQUFJQyxJQUFKLENBQVNELElBQVQsQ0FBUjtBQUNBLFVBQUlHLFNBQVNILEtBQUtJLFVBQUwsRUFBYjtBQUNBLFVBQUlELE9BQU9FLFFBQVAsR0FBa0J4RCxNQUFsQixJQUE0QixDQUFoQyxFQUNFc0QsVUFBVSxHQUFWOztBQUVGO0FBQ0E7QUFDQSxhQUFPSCxLQUFLTSxRQUFMLEtBQWtCLEdBQWxCLEdBQXdCSCxNQUF4QixHQUFpQyxLQUF4QztBQUNELEtBWkQsQ0FZRSxPQUFPSSxDQUFQLEVBQVU7QUFDVixhQUFPeEIsS0FBUDtBQUNEO0FBQ0YiLCJmaWxlIjoiaW5kZXgud3hwIiwic291cmNlc0NvbnRlbnQiOlsiZXhwb3J0IGRlZmF1bHQge1xuICAgIGNvbmZpZzoge1xuICAgICAgbmF2aWdhdGlvbkJhclRpdGxlVGV4dDogJ+S5sOWNlScsXG4gICAgICBuYXZpZ2F0aW9uQmFyQmFja2dyb3VuZENvbG9yOiAnI0U4RThFOCcsXG4gICAgICBuYXZpZ2F0aW9uQmFyVGV4dFN0eWxlOiAnYmxhY2snLFxuICAgICAgdXNpbmdDb21wb25lbnRzOiB7XG4gICAgICAgICd3eGMtZGlhbG9nJzogJ0BtaW51aS93eGMtZGlhbG9nJyxcbiAgICAgICAgJ3d4Yy1hYm5vcic6ICdAbWludWkvd3hjLWFibm9yJyxcbiAgICAgICAgJ3d4Yy1lbGlwJzogJ0BtaW51aS93eGMtZWxpcCcsXG4gICAgICB9XG4gICAgfSxcbiAgICBkYXRhOiB7XG4gICAgICBhY2NvdW50QW1vdW50OiAwLCAvLyDotKbmiLfkvZnpop1cbiAgICAgIGFtb3VudDogMCxcbiAgICAgIG9yZGVyVHlwZTogJycsXG4gICAgICBvcmRlcklkOiAnJyxcbiAgICAgIGxhc3RDb21wb25lbnQ6ICcnLFxuICAgICAgZm9ybUlkOiAnJyxcbiAgICAgIGxhc3RJbmRleDogJycsXG4gICAgICBvcmRlckxpc3Q6IFtdLFxuICAgICAgcGF5VHlwZTogJycsXG4gICAgICBiZWF1dGljaWFuQ29kZTogJycsXG4gICAgICBjb3Vwb25Db2RlOiAnJ1xuICAgIH0sXG4gICAgb25Mb2FkOiBmdW5jdGlvbiAob3B0aW9ucykge1xuICAgICAgLy8gY29uc29sZS5sb2cob3B0aW9ucylcbiAgICB9LFxuICAgIG9uU2hvdzogZnVuY3Rpb24gKCkge1xuICAgICAgdGhpcy5nZXRPcmRlckxpc3QoKVxuICAgIH0sXG4gICAgZ2V0T3JkZXJMaXN0OiBmdW5jdGlvbiAoKSB7XG4gICAgICBsZXQgYXBwID0gZ2V0QXBwKClcbiAgICAgIGFwcC5nZXQoJ2NlbnRlci9vcmRlcicsIHtvcmRlcl9zdGF0dXM6IDF9KS50aGVuKGRhdGEgPT4ge1xuICAgICAgICBsZXQgcmVzdWx0ID0gZGF0YS5kYXRhXG4gICAgICAgIHJlc3VsdC5jb250ZW50LmZvckVhY2goaXRlbSA9PiBpdGVtLmFwcG9pbnRtZW50X2VuZF90aW1lID0gdGhpcy5fcmVhbERheShpdGVtLmFwcG9pbnRtZW50X2RheSwgaXRlbS5hcHBvaW50bWVudF9lbmRfdGltZSkpXG4gICAgICAgIHRoaXMuc2V0RGF0YSh7XG4gICAgICAgICAgb3JkZXJMaXN0OiByZXN1bHQuY29udGVudFxuICAgICAgICB9KVxuICAgICAgfSlcbiAgICB9LFxuICAgIHBheU9mZmxpbmU6IGZ1bmN0aW9uICgpIHtcbiAgICAgIGxldCBhcHAgPSBnZXRBcHAoKVxuICAgICAgaWYgKHRoaXMuZGF0YS5wYXlUeXBlID09PSAnY2FzaCcpIHtcbiAgICAgICAgaWYgKHRoaXMuZGF0YS5iZWF1dGljaWFuQ29kZS50cmltKCkubGVuZ3RoID09PSAwKSB7XG4gICAgICAgICAgd3guc2hvd1RvYXN0KHtcbiAgICAgICAgICAgIHRpdGxlOiAn566h5a625bel5Y+35LiN6IO95Li656m6JyxcbiAgICAgICAgICAgIGljb246ICdub25lJ1xuICAgICAgICAgIH0pXG5cbiAgICAgICAgICByZXR1cm5cbiAgICAgICAgfVxuICAgICAgfVxuXG4gICAgICAvLyDlm6LotK1cbiAgICAgIGlmICh0aGlzLmRhdGEucGF5VHlwZSA9PT0gJ2dyb3VwJykge1xuICAgICAgICBpZiAoIXRoaXMuZGF0YS5jb3Vwb25Db2RlLm1hdGNoKC9eXFxkezEwfSQvKSAmJiAhdGhpcy5kYXRhLmNvdXBvbkNvZGUubWF0Y2goL15cXGR7MTJ9JC8pKSB7XG4gICAgICAgICAgd3guc2hvd1RvYXN0KHtcbiAgICAgICAgICAgIHRpdGxlOiAn5Yi45Y+36L6T5YWl6ZSZ6K+vLOWIuOWPt+S9jeaVsOS4ujEw5L2N5oiW6ICFMTLkvY0nLFxuICAgICAgICAgICAgaWNvbjogJ25vbmUnXG4gICAgICAgICAgfSlcblxuICAgICAgICAgIHJldHVyblxuICAgICAgICB9XG4gICAgICB9XG5cblxuICAgICAgYXBwLnBvc3QoYGNlbnRlci9jb21wbGV0ZU9yZGVyLyR7dGhpcy5kYXRhLm9yZGVySWR9YCwge1xuICAgICAgICB0eXBlOiB0aGlzLmRhdGEucGF5VHlwZSxcbiAgICAgICAgYmVhdXRpY2lhbl9jb2RlOiB0aGlzLmRhdGEuYmVhdXRpY2lhbkNvZGUsIGNvdXBvbl9jb2RlOiB0aGlzLmRhdGEuY291cG9uQ29kZVxuICAgICAgfSkudGhlbigoKSA9PiB7XG4gICAgICAgIHRoaXMuZ2V0T3JkZXJMaXN0KClcbiAgICAgICAgdGhpcy5jYW5jZWwoKVxuICAgICAgfSlcbiAgICAgICAgLmNhdGNoKGVycm9yID0+IHtcbiAgICAgICAgICB3eC5zaG93VG9hc3Qoe1xuICAgICAgICAgICAgdGl0bGU6IGVycm9yLmRldGFpbCB8fCAn5pSv5LuY5aSx6LSl77yM6K+36YeN6K+VJyxcbiAgICAgICAgICAgIGR1cmF0aW9uOiAyMDAwLFxuICAgICAgICAgICAgaWNvbjogJ25vbmUnXG4gICAgICAgICAgfSlcbiAgICAgICAgfSlcbiAgICB9LFxuXG4gICAgcGF5T25saW5lOiBmdW5jdGlvbiAoKSB7XG4gICAgICBsZXQgYXBwID0gZ2V0QXBwKClcbiAgICAgIGFwcC5nZXQoYG9yZGVyL3BheS8ke3RoaXMuZGF0YS5vcmRlck5vfWApXG4gICAgICAgIC50aGVuKGRhdGEgPT4ge1xuICAgICAgICAgIGxldCByZXN1bHQgPSBkYXRhLmRhdGFcbiAgICAgICAgICBsZXQgc2VsZiA9IHRoaXNcbiAgICAgICAgICBsZXQgcGF5UGFyYW1zID0ge1xuICAgICAgICAgICAgJ3N1Y2Nlc3MnOiBmdW5jdGlvbiAocmVzKSB7XG5cbiAgICAgICAgICAgICAgd3guc2hvd1RvYXN0KHtcbiAgICAgICAgICAgICAgICB0aXRsZTogJ+aUr+S7mOaIkOWKnyznrYnlvoXmlbDmja7noa7orqTvvIzor7fnqI3nrYkuLi4nLFxuICAgICAgICAgICAgICAgIGR1cmF0aW9uOiAzMDAwLFxuICAgICAgICAgICAgICAgIGljb246ICdub25lJ1xuICAgICAgICAgICAgICB9KVxuXG4gICAgICAgICAgICAgIHNlbGYuY2FuY2VsKClcblxuICAgICAgICAgICAgICBzZXRUaW1lb3V0KHggPT4gc2VsZi5nZXRPcmRlckxpc3QoKSwgMjAwMClcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAnZmFpbCc6IGZ1bmN0aW9uIChyZXMpIHtcbiAgICAgICAgICAgICAgLy8gd3guc2hvd1RvYXN0KHtcbiAgICAgICAgICAgICAgLy8gICB0aXRsZTogJ+aUr+S7mOWksei0pSwg6K+36YeN6K+VLi4uJyxcbiAgICAgICAgICAgICAgLy8gICBkdXJhdGlvbjogMjAwMCxcbiAgICAgICAgICAgICAgLy8gICBpY29uOiAnbm9uZSdcbiAgICAgICAgICAgICAgLy8gfSlcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9XG5cbiAgICAgICAgICBPYmplY3QuYXNzaWduKHBheVBhcmFtcywgcmVzdWx0LmNvbnRlbnQpXG5cbiAgICAgICAgICB3eC5yZXF1ZXN0UGF5bWVudChwYXlQYXJhbXMpXG4gICAgICAgIH0pXG4gICAgICAgIC5jYXRjaChlcnJvciA9PiB7XG4gICAgICAgICAgd3guc2hvd1RvYXN0KHtcbiAgICAgICAgICAgIHRpdGxlOiBlcnJvci5kZXRhaWwgfHwgJ+aUr+S7mOWksei0pe+8jOivt+mHjeivlScsXG4gICAgICAgICAgICBkdXJhdGlvbjogMjAwMCxcbiAgICAgICAgICAgIGljb246ICdub25lJ1xuICAgICAgICAgIH0pXG4gICAgICAgIH0pXG4gICAgfSxcblxuICAgIC8vIOS9memineaUr+S7mFxuICAgIHBheVJlY2hhcmdlKCkge1xuICAgICAgbGV0IGFwcCA9IGdldEFwcCgpXG4gICAgICBjb25zdCBzZWxmID0gdGhpc1xuXG4gICAgICBhcHAuZ2V0KGBSZWNoYXJnZUNhcmQvcmVjaGFyZ2VQYXltZW50LyR7dGhpcy5kYXRhLm9yZGVyTm99YClcbiAgICAgICAgLnRoZW4oZGF0YSA9PiB7XG4gICAgICAgICAgd3guc2hvd1RvYXN0KHtcbiAgICAgICAgICAgICAgICB0aXRsZTogJ+aUr+S7mOaIkOWKnyznrYnlvoXmlbDmja7noa7orqTvvIzor7fnqI3nrYkuLi4nLFxuICAgICAgICAgICAgICAgIGR1cmF0aW9uOiAzMDAwLFxuICAgICAgICAgICAgICAgIGljb246ICdub25lJ1xuICAgICAgICAgICAgICB9KVxuXG4gICAgICAgICAgICAgIHNlbGYuY2FuY2VsKClcblxuICAgICAgICAgICAgICBzZXRUaW1lb3V0KHggPT4gc2VsZi5nZXRPcmRlckxpc3QoKSwgMjAwMClcbiAgICAgICAgfSlcbiAgICAgICAgLmNhdGNoKGVycm9yID0+IHtcbiAgICAgICAgICB3eC5zaG93VG9hc3Qoe1xuICAgICAgICAgICAgdGl0bGU6IGVycm9yLmRldGFpbCB8fCAn5pSv5LuY5aSx6LSl77yM6K+36YeN6K+VJyxcbiAgICAgICAgICAgIGR1cmF0aW9uOiAyMDAwLFxuICAgICAgICAgICAgaWNvbjogJ25vbmUnXG4gICAgICAgICAgfSlcbiAgICAgICAgfSlcbiAgICB9LFxuXG5cbiAgICBjYXNoOiBmdW5jdGlvbiAoZXZlbnQpIHtcbiAgICAgIGxldCBpZCA9IGV2ZW50LmN1cnJlbnRUYXJnZXQuZGF0YXNldC5pZFxuICAgICAgdGhpcy5zZXREYXRhKHtcbiAgICAgICAgcGF5VHlwZTogJ2Nhc2gnLFxuICAgICAgICBvcmRlcklkOiBpZCxcbiAgICAgIH0pXG4gICAgICBsZXQgZGlhbG9nQ29tcG9uZW50ID0gdGhpcy5kYXRhLmxhc3RDb21wb25lbnQgPSB0aGlzLnNlbGVjdENvbXBvbmVudCgnLnd4Yy1jYXNoJylcbiAgICAgIGRpYWxvZ0NvbXBvbmVudCAmJiBkaWFsb2dDb21wb25lbnQuc2hvdygpO1xuICAgIH0sXG4gICAgaGFuZGxlckJlYXV0aWNpYW46IGZ1bmN0aW9uIChldmVudCkge1xuICAgICAgbGV0IHZhbHVlID0gZXZlbnQuZGV0YWlsLnZhbHVlXG4gICAgICB0aGlzLnNldERhdGEoe1xuICAgICAgICBiZWF1dGljaWFuQ29kZTogdmFsdWVcbiAgICAgIH0pXG4gICAgfSxcbiAgICBoYW5kbGVyQ291cG9uQ29kZTogZnVuY3Rpb24gKGV2ZW50KSB7XG4gICAgICBsZXQgdmFsdWUgPSBldmVudC5kZXRhaWwudmFsdWVcbiAgICAgIHRoaXMuc2V0RGF0YSh7XG4gICAgICAgIGNvdXBvbkNvZGU6IHZhbHVlXG4gICAgICB9KVxuICAgIH0sXG5cbiAgICBzY2FuOiBmdW5jdGlvbiAoZXZlbnQpIHtcbiAgICAgIGxldCBpZCA9IGV2ZW50LmN1cnJlbnRUYXJnZXQuZGF0YXNldC5pZFxuICAgICAgdGhpcy5zZXREYXRhKHtcbiAgICAgICAgcGF5VHlwZTogJ3NjYW4nLFxuICAgICAgICBvcmRlcklkOiBpZFxuICAgICAgfSlcbiAgICAgIGxldCBkaWFsb2dDb21wb25lbnQgPSB0aGlzLmRhdGEubGFzdENvbXBvbmVudCA9IHRoaXMuc2VsZWN0Q29tcG9uZW50KCcud3hjLXNjYW4nKVxuICAgICAgZGlhbG9nQ29tcG9uZW50ICYmIGRpYWxvZ0NvbXBvbmVudC5zaG93KCk7XG4gICAgfSxcbiAgICBncm91cEJ5OiBmdW5jdGlvbiAoZXZlbnQpIHtcbiAgICAgIGxldCBpZCA9IGV2ZW50LmN1cnJlbnRUYXJnZXQuZGF0YXNldC5pZFxuICAgICAgdGhpcy5zZXREYXRhKHtcbiAgICAgICAgcGF5VHlwZTogJ2dyb3VwJyxcbiAgICAgICAgb3JkZXJJZDogaWRcbiAgICAgIH0pXG4gICAgICBsZXQgZGlhbG9nQ29tcG9uZW50ID0gdGhpcy5kYXRhLmxhc3RDb21wb25lbnQgPSB0aGlzLnNlbGVjdENvbXBvbmVudCgnLnd4Yy1ncm91cCcpXG4gICAgICBkaWFsb2dDb21wb25lbnQgJiYgZGlhbG9nQ29tcG9uZW50LnNob3coKTtcbiAgICB9LFxuXG4gICAgLy8g5Zyo57q/5pSv5LuYXG4gICAgb25saW5lOiBmdW5jdGlvbiAoZXZlbnQpIHtcbiAgICAgIGxldCBvcmRlck5vID0gZXZlbnQuY3VycmVudFRhcmdldC5kYXRhc2V0LmlkXG4gICAgICBsZXQgYW1vdW50ID0gZXZlbnQuY3VycmVudFRhcmdldC5kYXRhc2V0LmFtb3VudCAvIDFcbiAgICAgIHRoaXMuc2V0RGF0YSh7XG4gICAgICAgIHBheVR5cGU6ICdvbmxpbmUnLFxuICAgICAgICBvcmRlck5vOiBvcmRlck5vLFxuICAgICAgICBhbW91bnQ6IGFtb3VudCxcbiAgICAgIH0pXG4gICAgICBsZXQgZGlhbG9nQ29tcG9uZW50ID0gdGhpcy5kYXRhLmxhc3RDb21wb25lbnQgPSB0aGlzLnNlbGVjdENvbXBvbmVudCgnLnd4Yy1vbmxpbmUnKVxuICAgICAgZGlhbG9nQ29tcG9uZW50ICYmIGRpYWxvZ0NvbXBvbmVudC5zaG93KCk7XG4gICAgfSxcblxuICAgIC8vIOS9memineaUr+S7mOW8ueeql1xuICAgIHJlY2hhcmdlUGF5bWVudDogZnVuY3Rpb24gKGV2ZW50KSB7XG4gICAgICAvLyDmn6Xor6LotKbmiLfkvZnpop1cbiAgICAgIGxldCBhcHAgPSBnZXRBcHAoKVxuICAgICAgbGV0IG9yZGVyTm8gPSBldmVudC5jdXJyZW50VGFyZ2V0LmRhdGFzZXQuaWRcbiAgICAgIGxldCBhbW91bnQgPSBldmVudC5jdXJyZW50VGFyZ2V0LmRhdGFzZXQuYW1vdW50IC8gMVxuXG4gICAgICBhcHAuZ2V0KGByZWNoYXJnZUNhcmQvZ2V0TXlSZWNoYXJnZUNhcmRUb3RhbEFtb3VudC8ke29yZGVyTm99YCkudGhlbihkYXRhID0+IHtcbiAgICAgICAgY29uc3QgYWNjb3VudEFtb3VudCA9IGRhdGEuZGF0YS5jb250ZW50LmFtb3VudFxuICAgICAgICBjb25zdCByZWFsUGF5bWVudEFtb3VudCA9IGRhdGEuZGF0YS5jb250ZW50LnJlYWxfcGF5X2Ftb3VudFxuICAgICAgICBpZiAoYWNjb3VudEFtb3VudCA8PSAwKSB7XG4gICAgICAgICAgcmV0dXJuIHd4Lm1lc3NhZ2UoJ+i0puaIt+S9memineS4ujDvvIzkuI3og73mlK/ku5gnKVxuICAgICAgICB9XG5cbiAgICAgICAgaWYgKGFtb3VudCA+IGFjY291bnRBbW91bnQpIHtcbiAgICAgICAgICByZXR1cm4gd3gubWVzc2FnZShg6LSm5oi35L2Z6aKd5Li6Ou+/pSR7YWNjb3VudEFtb3VudH3vvIzkvZnpop3kuI3otrPvvIzkuI3og73mlK/ku5hgKVxuICAgICAgICB9XG5cbiAgICAgICAgdGhpcy5zZXREYXRhKHtcbiAgICAgICAgICBhY2NvdW50QW1vdW50XG4gICAgICAgIH0sICgpID0+IHtcbiAgICAgICAgICB0aGlzLnNldERhdGEoe1xuICAgICAgICAgICAgcGF5VHlwZTogJ3JlY2hhcmdlJyxcbiAgICAgICAgICAgIG9yZGVyTm86IG9yZGVyTm8sXG4gICAgICAgICAgICBhbW91bnQ6IHJlYWxQYXltZW50QW1vdW50LFxuICAgICAgICAgIH0pXG5cbiAgICAgICAgICBsZXQgZGlhbG9nQ29tcG9uZW50ID0gdGhpcy5kYXRhLmxhc3RDb21wb25lbnQgPSB0aGlzLnNlbGVjdENvbXBvbmVudCgnLnd4Yy1yZWNoYXJnZScpXG4gICAgICAgICAgZGlhbG9nQ29tcG9uZW50ICYmIGRpYWxvZ0NvbXBvbmVudC5zaG93KCk7XG4gICAgICAgIH0pXG4gICAgICB9KVxuICAgICAgXG4gICAgfSxcblxuXG4gICAgY2FuY2VsOiBmdW5jdGlvbiAoKSB7XG4gICAgICB0aGlzLmRhdGEubGFzdENvbXBvbmVudC5oaWRlKCk7XG5cbiAgICAgIHRoaXMuc2V0RGF0YSh7XG4gICAgICAgIGFtb3VudDogMCxcbiAgICAgICAgb3JkZXJUeXBlOiAnJyxcbiAgICAgICAgb3JkZXJJZDogJycsXG4gICAgICAgIGxhc3RDb21wb25lbnQ6ICcnLFxuICAgICAgICBmb3JtSWQ6ICcnLFxuICAgICAgICBsYXN0SW5kZXg6ICcnLFxuICAgICAgICBwYXlUeXBlOiAnJyxcbiAgICAgICAgYmVhdXRpY2lhbkNvZGU6ICcnLFxuICAgICAgICBjb3Vwb25Db2RlOiAnJ1xuICAgICAgfSlcbiAgICB9LFxuXG4gICAgY2FuY2VsT3JkZXJDb25maXJtOiBmdW5jdGlvbiAoKSB7XG4gICAgICBsZXQgYXBwID0gZ2V0QXBwKClcbiAgICAgIGxldCBmb3JtSWQgPSB0aGlzLmRhdGEuZm9ybUlkXG4gICAgICBsZXQgb3JkZXJJZCA9IHRoaXMuZGF0YS5vcmRlcklkXG4gICAgICBsZXQgaW5kZXggPSB0aGlzLmRhdGEubGFzdEluZGV4XG5cbiAgICAgIGFwcC5nZXQoJ2NlbnRlci9jYW5jZWxPcmRlci8nICsgb3JkZXJJZCwge2Zvcm1JZDogZm9ybUlkfSlcbiAgICAgICAgLnRoZW4oZGF0YSA9PiB7XG4gICAgICAgICAgbGV0IG9yZGVyTGlzdCA9IHRoaXMuZGF0YS5vcmRlckxpc3RcbiAgICAgICAgICBvcmRlckxpc3RbaW5kZXhdLm9yZGVyX3N0YXR1cyA9IDJcbiAgICAgICAgICB0aGlzLmNhbmNlbCgpXG4gICAgICAgIH0pXG4gICAgICAgIC5jYXRjaChlcnJvciA9PiB7XG4gICAgICAgICAgd3guc2hvd1RvYXN0KHtcbiAgICAgICAgICAgIHRpdGxlOiBlcnJvci5kZXRhaWxcbiAgICAgICAgICB9KVxuICAgICAgICB9KVxuICAgIH0sXG4gICAgY2FuY2VsT3JkZXI6IGZ1bmN0aW9uIChldmVudCkge1xuXG4gICAgICBsZXQgZGlhbG9nQ29tcG9uZW50ID0gdGhpcy5kYXRhLmxhc3RDb21wb25lbnQgPSB0aGlzLnNlbGVjdENvbXBvbmVudCgnLnd4Yy1jYW5jZWwtb3JkZXInKVxuICAgICAgZGlhbG9nQ29tcG9uZW50ICYmIGRpYWxvZ0NvbXBvbmVudC5zaG93KCk7XG5cbiAgICAgIGxldCBmb3JtSWQgPSBldmVudC5kZXRhaWwuZm9ybUlkXG4gICAgICBsZXQgb3JkZXJJZCA9IGV2ZW50LmRldGFpbC50YXJnZXQuZGF0YXNldC5pZFxuICAgICAgbGV0IGluZGV4ID0gZXZlbnQuZGV0YWlsLnRhcmdldC5kYXRhc2V0LmluZGV4XG4gICAgICB0aGlzLnNldERhdGEoe1xuICAgICAgICBmb3JtSWQ6IGZvcm1JZCxcbiAgICAgICAgb3JkZXJJZDogb3JkZXJJZCxcbiAgICAgICAgbGFzdEluZGV4OiBpbmRleFxuICAgICAgfSlcbiAgICB9LFxuICAgIF9yZWFsRGF5OiBmdW5jdGlvbiAoZGF5LCB2YWx1ZSkge1xuICAgICAgdHJ5IHtcbiAgICAgICAgdmFyIF9kYXkgPSBkYXkgKyAnICcgKyB2YWx1ZVxuICAgICAgICBfZGF5ID0gX2RheS5yZXBsYWNlKC8tL2csICcvJylcbiAgICAgICAgbGV0IGRhdGUgPSAobmV3IERhdGUoX2RheSkpLmdldFRpbWUoKSArIDMwICogNjAgKiAxMDAwXG4gICAgICAgIGRhdGUgPSAobmV3IERhdGUoZGF0ZSkpXG4gICAgICAgIGxldCBtaW51dGUgPSBkYXRlLmdldE1pbnV0ZXMoKVxuICAgICAgICBpZiAobWludXRlLnRvU3RyaW5nKCkubGVuZ3RoID09IDEpXG4gICAgICAgICAgbWludXRlICs9ICcwJ1xuXG4gICAgICAgIC8vIGNvbnNvbGUubG9nKHZhbHVlKVxuICAgICAgICAvLyBjb25zb2xlLmxvZyhkYXkpXG4gICAgICAgIHJldHVybiBkYXRlLmdldEhvdXJzKCkgKyAnOicgKyBtaW51dGUgKyAnOjAwJ1xuICAgICAgfSBjYXRjaCAoZSkge1xuICAgICAgICByZXR1cm4gdmFsdWVcbiAgICAgIH1cbiAgICB9XG5cbiAgfSJdfQ==