'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = Page({
  data: {
    '__code__': {
      readme: ''
    },

    userInfo: {},
    authed: false,
    loading: false,
    noPhone: false
  },

  onShow: function onShow() {
    var _this2 = this;

    // throw new Error('发送错误了')
    this.setData({
      userInfo: {},
      authed: false,
      loading: false,
      noPhone: false
    }, function () {
      var noPhone = !!getApp().globalData.userInfo.noPhone;
      _this2.setData({
        authed: !!getApp().getSessionId(),
        noPhone: noPhone
      });
    });
  },

  getPhoneNumber: function getPhoneNumber(res) {
    var _this3 = this;

    var _this = this;
    if (!res.detail.iv) {
      wx.showToast({
        title: '获取手机号失败，请重试',
        icon: 'none'
      });
      return;
    }

    var app = getApp();

    // res.detail
    // encryptedData: "3aKTLbNlVjSNSQiMO7pKpmB6OkRD5u8h8jL+y2Ap2vBymLUsNV6qzKpOG+t0TeasWEKqki2U9+g477mFicGq0PIZ0DE8tBpSK7Bft+vgG2ZUwBE2F/Xz28baZcFVShIgxo1HbUDVBCI25M3LTXeMqnnFuA2EoGbMtvu4tTzD6cbqPZpESuLlQM6o1QkwYu73fzumV6Vna6iUlt5psUuioA=="
    // errMsg: "getPhoneNumber:ok"
    // iv: "mYO48TOme5wPMw1e7RS4Sg=="

    var userInfo = this.data.userInfo;
    if (Object.keys(this.data.userInfo).length <= 1) {
      this.setData({
        userInfo: getApp().getUserInfo()
      });

      userInfo = getApp().getUserInfo();
    }

    app.post('bind/bindMe', {
      enc_detail: JSON.stringify(res.detail),
      user_info: JSON.stringify(userInfo)
    }).then(function (data) {
      app.globalData.noPhone = false;
      var userInfo = _this3.data.userInfo;
      userInfo.noPhone = false;

      // 隐藏
      _this3.setData({
        noPhone: false
      });

      app.setUserInfo(userInfo);

      wx.navigateBack();
    });
  },
  getUserInfo: function getUserInfo(res) {
    var _this4 = this;

    if (!res.detail.iv) {
      wx.showToast({
        title: '用户授权失败，请重试',
        icon: 'none'
      });
      return;
    }

    var app = getApp();

    app.login(JSON.stringify(res.detail)).then(function (data) {
      // data 为session_id
      if (!res.detail.userInfo) {
        return wx.showToast({
          title: '用户授权失败，请重试',
          icon: 'none'
        });
      }

      // 获取了用户信息
      var userInfo = res.detail.userInfo;
      userInfo.noPhone = data.noPhone;

      _this4.setData({
        authed: true,
        noPhone: data.noPhone,
        userInfo: userInfo
      });

      app.setUserInfo(userInfo);

      // 有手机号，直接返回
      if (!data.noPhone) {
        app.globalData.noPhone = false;
        wx.navigateBack();
      }
    }).catch(function (e) {
      wx.showToast({
        title: '登录失败，请重试',
        icon: 'none'
      });
    });
  },

  handlerPhone: function handlerPhone(event) {
    var value = event.detail.value;
    this.setData({
      phone: value
    });
  },
  handlerSmsCode: function handlerSmsCode(event) {
    var value = event.detail.value;
    this.setData({
      smsCode: value
    });
  },
  login: function login() {
    var app = getApp();
    if (!this.data.smsCode || !/^\d{6}$/.test(this.data.smsCode)) {
      wx.showToast({
        title: '验证码错误',
        icon: 'none'
      });
      return;
    }

    app.get('bind/bindMe', { code: this.data.smsCode, phone: this.data.phone, user_info: this.data.userInfo }).then(function (data) {
      return setTimeout(function () {
        return wx.switchTab({
          url: '/pages/appointment/index'
        });
      }, 500);
    }).catch(function (error) {
      return wx.showToast({
        title: error.detail || '登录失败，请重试',
        icon: 'none'
      });
    });
  },
  sendCode: function sendCode() {
    var _this5 = this;

    var app = getApp();

    if (!this.data.phone || !/^1\d{10}$/.test(this.data.phone)) {
      wx.showToast({
        title: '手机号格式错误',
        icon: 'none'
      });
      return;
    }

    this.setData({
      start: true
    });

    var intervalCounts = 60;

    this.setData({
      startText: intervalCounts-- + 's'
    });

    var interval = setInterval(function (x) {
      _this5.setData({
        startText: intervalCounts-- + 's'
      });

      if (intervalCounts == -1) {
        clearInterval(interval);
        _this5.setData({
          start: false,
          startText: '发送验证码'
        });
      }
    }, 1000);

    app.get('sms/send/' + this.data.phone).then(function (data) {
      wx.showToast({ title: '验证码已发送，请注意查收', icon: 'none' });
    }).catch(function (error) {
      return wx.showToast({ title: error.detail || '登录失败，请重试', icon: 'none' });
    });
  }
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImluZGV4Lnd4cCJdLCJuYW1lcyI6WyJkYXRhIiwidXNlckluZm8iLCJhdXRoZWQiLCJsb2FkaW5nIiwibm9QaG9uZSIsIm9uU2hvdyIsInNldERhdGEiLCJnZXRBcHAiLCJnbG9iYWxEYXRhIiwiZ2V0U2Vzc2lvbklkIiwiZ2V0UGhvbmVOdW1iZXIiLCJyZXMiLCJfdGhpcyIsImRldGFpbCIsIml2Iiwid3giLCJzaG93VG9hc3QiLCJ0aXRsZSIsImljb24iLCJhcHAiLCJPYmplY3QiLCJrZXlzIiwibGVuZ3RoIiwiZ2V0VXNlckluZm8iLCJwb3N0IiwiZW5jX2RldGFpbCIsIkpTT04iLCJzdHJpbmdpZnkiLCJ1c2VyX2luZm8iLCJ0aGVuIiwic2V0VXNlckluZm8iLCJuYXZpZ2F0ZUJhY2siLCJsb2dpbiIsImNhdGNoIiwiaGFuZGxlclBob25lIiwiZXZlbnQiLCJ2YWx1ZSIsInBob25lIiwiaGFuZGxlclNtc0NvZGUiLCJzbXNDb2RlIiwidGVzdCIsImdldCIsImNvZGUiLCJzZXRUaW1lb3V0Iiwic3dpdGNoVGFiIiwidXJsIiwiZXJyb3IiLCJzZW5kQ29kZSIsInN0YXJ0IiwiaW50ZXJ2YWxDb3VudHMiLCJzdGFydFRleHQiLCJpbnRlcnZhbCIsInNldEludGVydmFsIiwiY2xlYXJJbnRlcnZhbCJdLCJtYXBwaW5ncyI6Ijs7Ozs7O0FBU0lBLFFBQU07QUFBQTtBQUFBO0FBQUE7O0FBQ0pDLGNBQVUsRUFETjtBQUVKQyxZQUFRLEtBRko7QUFHSkMsYUFBUyxLQUhMO0FBSUpDLGFBQVM7QUFKTCxHOztBQU9OQyxVQUFRLGtCQUFZO0FBQUE7O0FBQ2xCO0FBQ0EsU0FBS0MsT0FBTCxDQUFhO0FBQ1hMLGdCQUFVLEVBREM7QUFFWEMsY0FBUSxLQUZHO0FBR1hDLGVBQVMsS0FIRTtBQUlYQyxlQUFTO0FBSkUsS0FBYixFQUtHLFlBQU07QUFDUCxVQUFNQSxVQUFVLENBQUMsQ0FBQ0csU0FBU0MsVUFBVCxDQUFvQlAsUUFBcEIsQ0FBNkJHLE9BQS9DO0FBQ0Es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ekIsRUFBNEQ7QUFDMUR0QixTQUFHQyxTQUFILENBQWE7QUFDWEMsZUFBTyxTQURJO0FBRVhDLGNBQU07QUFGSyxPQUFiO0FBSUE7QUFDRDs7QUFFRCxTQUFLWixPQUFMLENBQWE7QUFDWDBDLGFBQU87QUFESSxLQUFiOztBQUlBLFFBQUlDLGlCQUFpQixFQUFyQjs7QUFFQSxTQUFLM0MsT0FBTCxDQUFhO0FBQ1g0QyxpQkFBY0QsZ0JBQWQ7QUFEVyxLQUFiOztBQUlBLFFBQUlFLFdBQVdDLFlBQVksYUFBSztBQUM5QixhQUFLOUMsT0FBTCxDQUFhO0FBQ1g0QyxtQkFBY0QsZ0JBQWQ7QUFEVyxPQUFiOztBQUlBLFVBQUlBLGtCQUFrQixDQUFDLENBQXZCLEVBQTBCO0FBQ3hCSSxzQkFBY0YsUUFBZDtBQUNBLGVBQUs3QyxPQUFMLENBQWE7QUFDWDBDLGlCQUFPLEtBREk7QUFFWEUscUJBQVc7QUFGQSxTQUFiO0FBSUQ7QUFDRixLQVpjLEVBWVosSUFaWSxDQUFmOztBQWNBL0IsUUFBSXNCLEdBQUosZUFBb0IsS0FBS3pDLElBQUwsQ0FBVXFDLEtBQTlCLEVBQ0dSLElBREgsQ0FDUSxnQkFBUTtBQUNaZCxTQUFHQyxTQUFILENBQWEsRUFBQ0MsT0FBTyxjQUFSLEVBQXdCQyxNQUFNLE1BQTlCLEVBQWI7QUFDRCxLQUhILEVBSUdlLEtBSkgsQ0FJUztBQUFBLGFBQVNsQixHQUFHQyxTQUFILENBQWEsRUFBQ0MsT0FBTzZCLE1BQU1qQyxNQUFOLElBQWdCLFVBQXhCLEVBQW9DSyxNQUFNLE1BQTFDLEVBQWIsQ0FBVDtBQUFBLEtBSlQ7QUFLRCIsImZpbGUiOiJpbmRleC53eHAiLCJzb3VyY2VzQ29udGVudCI6WyJleHBvcnQgZGVmYXVsdCB7XG4gICAgY29uZmlnOiB7XG4gICAgICBuYXZpZ2F0aW9uQmFyVGl0bGVUZXh0OiAn55m75b2VJyxcbiAgICAgIG5hdmlnYXRpb25CYXJCYWNrZ3JvdW5kQ29sb3I6ICcjRThFOEU4JyxcbiAgICAgIG5hdmlnYXRpb25CYXJUZXh0U3R5bGU6ICdibGFjaycsXG4gICAgICB1c2luZ0NvbXBvbmVudHM6IHtcbiAgICAgICAgJ3d4Yy1hdmF0YXInOiAnQG1pbnVpL3d4Yy1hdmF0YXInLFxuICAgICAgfVxuICAgIH0sXG4gICAgZGF0YToge1xuICAgICAgdXNlckluZm86IHt9LFxuICAgICAgYXV0aGVkOiBmYWxzZSxcbiAgICAgIGxvYWRpbmc6IGZhbHNlLFxuICAgICAgbm9QaG9uZTogZmFsc2VcbiAgICB9LFxuXG4gICAgb25TaG93OiBmdW5jdGlvbiAoKSB7XG4gICAgICAvLyB0aHJvdyBuZXcgRXJyb3IoJ+WPkemAgemUmeivr+S6hicpXG4gICAgICB0aGlzLnNldERhdGEoe1xuICAgICAgICB1c2VySW5mbzoge30sXG4gICAgICAgIGF1dGhlZDogZmFsc2UsXG4gICAgICAgIGxvYWRpbmc6IGZhbHNlLFxuICAgICAgICBub1Bob25lOiBmYWxzZVxuICAgICAgfSwgKCkgPT4ge1xuICAgICAgICBjb25zdCBub1Bob25lID0gISFnZXRBcHAoKS5nbG9iYWxEYXRhLnVzZXJJbmZvLm5vUGhvbmVcbiAgICAgICAgdGhpcy5zZXREYXRhKHtcbiAgICAgICAgICBhdXRoZWQ6ICEhZ2V0QXBwKCkuZ2V0U2Vzc2lvbklkKCksXG4gICAgICAgICAgbm9QaG9uZVxuICAgICAgICB9KVxuICAgICAgfSlcbiAgICB9LFxuXG4gICAgZ2V0UGhvbmVOdW1iZXIocmVzKSB7XG4gICAgICBsZXQgX3RoaXMgPSB0aGlzO1xuICAgICAgaWYgKCFyZXMuZGV0YWlsLml2KSB7XG4gICAgICAgIHd4LnNob3dUb2FzdCh7XG4gICAgICAgICAgdGl0bGU6ICfojrflj5bmiYvmnLrlj7flpLHotKXvvIzor7fph43or5UnLFxuICAgICAgICAgIGljb246ICdub25lJ1xuICAgICAgICB9KVxuICAgICAgICByZXR1cm5cbiAgICAgIH1cbiAgICAgIFxuICAgICAgY29uc3QgYXBwID0gZ2V0QXBwKClcblxuICAgICAgLy8gcmVzLmRldGFpbFxuICAgICAgLy8gZW5jcnlwdGVkRGF0YTogXCIzYUtUTGJObFZqU05TUWlNTzdwS3BtQjZPa1JENXU4aDhqTCt5MkFwMnZCeW1MVXNOVjZxektwT0crdDBUZWFzV0VLcWtpMlU5K2c0NzdtRmljR3EwUElaMERFOHRCcFNLN0JmdCt2Z0cyWlV3QkUyRi9YejI4YmFaY0ZWU2hJZ3hvMUhiVURWQkNJMjVNM0xUWGVNcW5uRnVBMkVvR2JNdHZ1NHRUekQ2Y2JxUFpwRVN1TGxRTTZvMVFrd1l1NzNmenVtVjZWbmE2aVVsdDVwc1V1aW9BPT1cIlxuICAgICAgLy8gZXJyTXNnOiBcImdldFBob25lTnVtYmVyOm9rXCJcbiAgICAgIC8vIGl2OiBcIm1ZTzQ4VE9tZTV3UE13MWU3UlM0U2c9PVwiXG5cbiAgICAgIGxldCB1c2VySW5mbyA9IHRoaXMuZGF0YS51c2VySW5mb1xuICAgICAgaWYgKE9iamVjdC5rZXlzKHRoaXMuZGF0YS51c2VySW5mbykubGVuZ3RoIDw9IDEpIHtcbiAgICAgICAgdGhpcy5zZXREYXRhKHtcbiAgICAgICAgICB1c2VySW5mbzogZ2V0QXBwKCkuZ2V0VXNlckluZm8oKVxuICAgICAgICB9KVxuXG4gICAgICAgIHVzZXJJbmZvID0gZ2V0QXBwKCkuZ2V0VXNlckluZm8oKVxuICAgICAgfVxuXG4gICAgICBhcHAucG9zdCgnYmluZC9iaW5kTWUnLCB7XG4gICAgICAgIGVuY19kZXRhaWw6IEpTT04uc3RyaW5naWZ5KHJlcy5kZXRhaWwpLFxuICAgICAgICB1c2VyX2luZm86IEpTT04uc3RyaW5naWZ5KHVzZXJJbmZvKVxuICAgICAgfSkudGhlbihkYXRhID0+IHtcbiAgICAgICAgYXBwLmdsb2JhbERhdGEubm9QaG9uZSA9IGZhbHNlXG4gICAgICAgIGxldCB1c2VySW5mbyA9IHRoaXMuZGF0YS51c2VySW5mb1xuICAgICAgICB1c2VySW5mby5ub1Bob25lID0gZmFsc2VcblxuICAgICAgICAvLyDpmpDol49cbiAgICAgICAgdGhpcy5zZXREYXRhKHtcbiAgICAgICAgICBub1Bob25lOiBmYWxzZVxuICAgICAgICB9KVxuXG4gICAgICAgIGFwcC5zZXRVc2VySW5mbyh1c2VySW5mbylcblxuICAgICAgICB3eC5uYXZpZ2F0ZUJhY2soKVxuICAgICAgfSlcblxuICAgIH0sXG5cbiAgICBnZXRVc2VySW5mbyhyZXMpIHtcbiAgICAgIGlmICghcmVzLmRldGFpbC5pdikge1xuICAgICAgICB3eC5zaG93VG9hc3Qoe1xuICAgICAgICAgIHRpdGxlOiAn55So5oi35o6I5p2D5aSx6LSl77yM6K+36YeN6K+VJyxcbiAgICAgICAgICBpY29uOiAnbm9uZSdcbiAgICAgICAgfSlcbiAgICAgICAgcmV0dXJuXG4gICAgICB9XG5cbiAgICAgIGNvbnN0IGFwcCA9IGdldEFwcCgpXG5cbiAgICAgIGFwcC5sb2dpbihKU09OLnN0cmluZ2lmeShyZXMuZGV0YWlsKSkudGhlbihkYXRhID0+IHsgLy8gZGF0YSDkuLpzZXNzaW9uX2lkXG4gICAgICAgIGlmICghcmVzLmRldGFpbC51c2VySW5mbykge1xuICAgICAgICAgIHJldHVybiB3eC5zaG93VG9hc3Qoe1xuICAgICAgICAgICAgdGl0bGU6ICfnlKjmiLfmjojmnYPlpLHotKXvvIzor7fph43or5UnLFxuICAgICAgICAgICAgaWNvbjogJ25vbmUnXG4gICAgICAgICAgfSlcbiAgICAgICAgfVxuXG4gICAgICAgIC8vIOiOt+WPluS6hueUqOaIt+S/oeaBr1xuICAgICAgICBjb25zdCB1c2VySW5mbyA9IHJlcy5kZXRhaWwudXNlckluZm9cbiAgICAgICAgdXNlckluZm8ubm9QaG9uZSA9IGRhdGEubm9QaG9uZVxuICAgICAgICBcbiAgICAgICAgdGhpcy5zZXREYXRhKHtcbiAgICAgICAgICBhdXRoZWQ6IHRydWUsXG4gICAgICAgICAgbm9QaG9uZTogZGF0YS5ub1Bob25lLFxuICAgICAgICAgIHVzZXJJbmZvXG4gICAgICAgIH0pXG5cbiAgICAgICAgIGFwcC5zZXRVc2VySW5mbyh1c2VySW5mbylcblxuICAgICAgICAvLyDmnInmiYvmnLrlj7fvvIznm7TmjqXov5Tlm55cbiAgICAgICAgaWYgKCFkYXRhLm5vUGhvbmUpIHtcbiAgICAgICAgICBhcHAuZ2xvYmFsRGF0YS5ub1Bob25lID0gZmFsc2VcbiAgICAgICAgICB3eC5uYXZpZ2F0ZUJhY2soKVxuICAgICAgICB9XG5cbiAgICAgIH0pLmNhdGNoKGUgPT4ge1xuICAgICAgICB3eC5zaG93VG9hc3Qoe1xuICAgICAgICAgIHRpdGxlOiAn55m75b2V5aSx6LSl77yM6K+36YeN6K+VJyxcbiAgICAgICAgICBpY29uOiAnbm9uZSdcbiAgICAgICAgfSlcbiAgICAgIH0pXG5cblxuICAgICAgXG5cbiAgICAgIFxuICAgIH0sICBcbiAgICBoYW5kbGVyUGhvbmU6IGZ1bmN0aW9uIChldmVudCkge1xuICAgICAgbGV0IHZhbHVlID0gZXZlbnQuZGV0YWlsLnZhbHVlXG4gICAgICB0aGlzLnNldERhdGEoe1xuICAgICAgICBwaG9uZTogdmFsdWVcbiAgICAgIH0pXG4gICAgfSxcbiAgICBoYW5kbGVyU21zQ29kZTogZnVuY3Rpb24gKGV2ZW50KSB7XG4gICAgICBsZXQgdmFsdWUgPSBldmVudC5kZXRhaWwudmFsdWVcbiAgICAgIHRoaXMuc2V0RGF0YSh7XG4gICAgICAgIHNtc0NvZGU6IHZhbHVlXG4gICAgICB9KVxuICAgIH0sXG4gICAgbG9naW46IGZ1bmN0aW9uICgpIHtcbiAgICAgIGxldCBhcHAgPSBnZXRBcHAoKVxuICAgICAgaWYgKCF0aGlzLmRhdGEuc21zQ29kZSB8fCAhL15cXGR7Nn0kLy50ZXN0KHRoaXMuZGF0YS5zbXNDb2RlKSkge1xuICAgICAgICB3eC5zaG93VG9hc3Qoe1xuICAgICAgICAgIHRpdGxlOiAn6aqM6K+B56CB6ZSZ6K+vJyxcbiAgICAgICAgICBpY29uOiAnbm9uZSdcbiAgICAgICAgfSk7XG4gICAgICAgIHJldHVyblxuICAgICAgfVxuXG4gICAgICBhcHAuZ2V0KCdiaW5kL2JpbmRNZScsIHtjb2RlOiB0aGlzLmRhdGEuc21zQ29kZSwgcGhvbmU6IHRoaXMuZGF0YS5waG9uZSwgdXNlcl9pbmZvOiB0aGlzLmRhdGEudXNlckluZm99KVxuICAgICAgICAudGhlbihkYXRhID0+IHNldFRpbWVvdXQoKCkgPT5cbiAgICAgICAgICAgIHd4LnN3aXRjaFRhYih7XG4gICAgICAgICAgICAgIHVybDogJy9wYWdlcy9hcHBvaW50bWVudC9pbmRleCdcbiAgICAgICAgICAgIH0pXG4gICAgICAgICAgLCA1MDApKVxuICAgICAgICAuY2F0Y2goZXJyb3IgPT5cbiAgICAgICAgICB3eC5zaG93VG9hc3Qoe1xuICAgICAgICAgICAgdGl0bGU6IGVycm9yLmRldGFpbCB8fCAn55m75b2V5aSx6LSl77yM6K+36YeN6K+VJyxcbiAgICAgICAgICAgIGljb246ICdub25lJ1xuICAgICAgICAgIH0pKVxuICAgIH0sXG4gICAgc2VuZENvZGU6IGZ1bmN0aW9uICgpIHtcbiAgICAgIGxldCBhcHAgPSBnZXRBcHAoKVxuXG4gICAgICBpZiAoIXRoaXMuZGF0YS5waG9uZSB8fCAhL14xXFxkezEwfSQvLnRlc3QodGhpcy5kYXRhLnBob25lKSkge1xuICAgICAgICB3eC5zaG93VG9hc3Qoe1xuICAgICAgICAgIHRpdGxlOiAn5omL5py65Y+35qC85byP6ZSZ6K+vJyxcbiAgICAgICAgICBpY29uOiAnbm9uZSdcbiAgICAgICAgfSk7XG4gICAgICAgIHJldHVyblxuICAgICAgfVxuXG4gICAgICB0aGlzLnNldERhdGEoe1xuICAgICAgICBzdGFydDogdHJ1ZVxuICAgICAgfSlcblxuICAgICAgbGV0IGludGVydmFsQ291bnRzID0gNjBcblxuICAgICAgdGhpcy5zZXREYXRhKHtcbiAgICAgICAgc3RhcnRUZXh0OiBgJHtpbnRlcnZhbENvdW50cy0tfXNgXG4gICAgICB9KVxuXG4gICAgICBsZXQgaW50ZXJ2YWwgPSBzZXRJbnRlcnZhbCh4ID0+IHtcbiAgICAgICAgdGhpcy5zZXREYXRhKHtcbiAgICAgICAgICBzdGFydFRleHQ6IGAke2ludGVydmFsQ291bnRzLS19c2BcbiAgICAgICAgfSlcblxuICAgICAgICBpZiAoaW50ZXJ2YWxDb3VudHMgPT0gLTEpIHtcbiAgICAgICAgICBjbGVhckludGVydmFsKGludGVydmFsKVxuICAgICAgICAgIHRoaXMuc2V0RGF0YSh7XG4gICAgICAgICAgICBzdGFydDogZmFsc2UsXG4gICAgICAgICAgICBzdGFydFRleHQ6ICflj5HpgIHpqozor4HnoIEnXG4gICAgICAgICAgfSlcbiAgICAgICAgfVxuICAgICAgfSwgMTAwMClcblxuICAgICAgYXBwLmdldChgc21zL3NlbmQvJHt0aGlzLmRhdGEucGhvbmV9YClcbiAgICAgICAgLnRoZW4oZGF0YSA9PiB7XG4gICAgICAgICAgd3guc2hvd1RvYXN0KHt0aXRsZTogJ+mqjOivgeeggeW3suWPkemAge+8jOivt+azqOaEj+afpeaUticsIGljb246ICdub25lJ30pXG4gICAgICAgIH0pXG4gICAgICAgIC5jYXRjaChlcnJvciA9PiB3eC5zaG93VG9hc3Qoe3RpdGxlOiBlcnJvci5kZXRhaWwgfHwgJ+eZu+W9leWksei0pe+8jOivt+mHjeivlScsIGljb246ICdub25lJ30pKVxuICAgIH0sXG4gIH0iXX0=