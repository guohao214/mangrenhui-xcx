'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = Page({
  data: {
    '__code__': {
      readme: ''
    },

    userInfo: {},
    authed: false,
    loading: false,
    noPhone: false
  },
  onShow: function onShow() {
    this.setData({
      userInfo: {},
      authed: false,
      loading: false,
      noPhone: false
    });
  },

  getPhoneNumber: function getPhoneNumber(res) {
    var _this2 = this;

    var _this = this;
    if (!res.detail.iv) {
      wx.showToast({
        title: '获取手机号失败，请重试',
        icon: 'none'
      });
      return;
    }

    var app = getApp();

    // res.detail
    // encryptedData: "3aKTLbNlVjSNSQiMO7pKpmB6OkRD5u8h8jL+y2Ap2vBymLUsNV6qzKpOG+t0TeasWEKqki2U9+g477mFicGq0PIZ0DE8tBpSK7Bft+vgG2ZUwBE2F/Xz28baZcFVShIgxo1HbUDVBCI25M3LTXeMqnnFuA2EoGbMtvu4tTzD6cbqPZpESuLlQM6o1QkwYu73fzumV6Vna6iUlt5psUuioA=="
    // errMsg: "getPhoneNumber:ok"
    // iv: "mYO48TOme5wPMw1e7RS4Sg=="

    app.post('bind/bindMe', {
      enc_detail: JSON.stringify(res.detail),
      user_info: JSON.stringify(this.data.userInfo)
    }).then(function (data) {
      app.globalData.noPhone = false;
      var userInfo = _this2.data.userInfo;
      userInfo.noPhone = false;

      // 隐藏
      _this2.setData({
        noPhone: false
      });

      app.setUserInfo(userInfo);

      wx.navigateBack();
    });
  },
  getUserInfo: function getUserInfo(res) {
    var _this3 = this;

    var app = getApp();

    app.login().then(function (data) {
      // data 为session_id
      if (!res.detail.userInfo) {
        return wx.showToast({
          title: '请您先授权',
          icon: 'none'
        });
      }

      // 获取了用户信息
      var userInfo = res.detail.userInfo;
      userInfo.noPhone = data.noPhone;

      _this3.setData({
        authed: true,
        noPhone: data.noPhone,
        userInfo: userInfo
      });

      app.setUserInfo(userInfo);

      // 有手机号，直接返回
      if (!data.noPhone) {
        app.globalData.noPhone = false;
        wx.navigateBack();
      }
    }).catch(function (e) {
      wx.showToast({
        title: '登录失败，请重试',
        icon: 'none'
      });
    });
  },

  handlerPhone: function handlerPhone(event) {
    var value = event.detail.value;
    this.setData({
      phone: value
    });
  },
  handlerSmsCode: function handlerSmsCode(event) {
    var value = event.detail.value;
    this.setData({
      smsCode: value
    });
  },
  login: function login() {
    var app = getApp();
    if (!this.data.smsCode || !/^\d{6}$/.test(this.data.smsCode)) {
      wx.showToast({
        title: '验证码错误',
        icon: 'none'
      });
      return;
    }

    app.get('bind/bindMe', { code: this.data.smsCode, phone: this.data.phone, user_info: this.data.userInfo }).then(function (data) {
      return setTimeout(function () {
        return wx.switchTab({
          url: '/pages/appointment/index'
        });
      }, 500);
    }).catch(function (error) {
      return wx.showToast({
        title: error.detail || '登录失败，请重试',
        icon: 'none'
      });
    });
  },
  sendCode: function sendCode() {
    var _this4 = this;

    var app = getApp();

    if (!this.data.phone || !/^1\d{10}$/.test(this.data.phone)) {
      wx.showToast({
        title: '手机号格式错误',
        icon: 'none'
      });
      return;
    }

    this.setData({
      start: true
    });

    var intervalCounts = 60;

    this.setData({
      startText: intervalCounts-- + 's'
    });

    var interval = setInterval(function (x) {
      _this4.setData({
        startText: intervalCounts-- + 's'
      });

      if (intervalCounts == -1) {
        clearInterval(interval);
        _this4.setData({
          start: false,
          startText: '发送验证码'
        });
      }
    }, 1000);

    app.get('sms/send/' + this.data.phone).then(function (data) {
      wx.showToast({ title: '验证码已发送，请注意查收', icon: 'none' });
    }).catch(function (error) {
      return wx.showToast({ title: error.detail || '登录失败，请重试', icon: 'none' });
    });
  }
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImluZGV4Lnd4cCJdLCJuYW1lcyI6WyJkYXRhIiwidXNlckluZm8iLCJhdXRoZWQiLCJsb2FkaW5nIiwibm9QaG9uZSIsIm9uU2hvdyIsInNldERhdGEiLCJnZXRQaG9uZU51bWJlciIsInJlcyIsIl90aGlzIiwiZGV0YWlsIiwiaXYiLCJ3eCIsInNob3dUb2FzdCIsInRpdGxlIiwiaWNvbiIsImFwcCIsImdldEFwcCIsInBvc3QiLCJlbmNfZGV0YWlsIiwiSlNPTiIsInN0cmluZ2lmeSIsInVzZXJfaW5mbyIsInRoZW4iLCJnbG9iYWxEYXRhIiwic2V0VXNlckluZm8iLCJuYXZpZ2F0ZUJhY2siLCJnZXRVc2VySW5mbyIsImxvZ2luIiwiY2F0Y2giLCJoYW5kbGVyUGhvbmUiLCJldmVudCIsInZhbHVlIiwicGhvbmUiLCJoYW5kbGVyU21zQ29kZSIsInNtc0NvZGUiLCJ0ZXN0IiwiZ2V0IiwiY29kZSIsInNldFRpbWVvdXQiLCJzd2l0Y2hUYWIiLCJ1cmwiLCJlcnJvciIsInNlbmRDb2RlIiwic3RhcnQiLCJpbnRlcnZhbENvdW50cyIsInN0YXJ0VGV4dCIsImludGVydmFsIiwic2V0SW50ZXJ2YWwiLCJjbGVhckludGVydmFsIl0sIm1hcHBpbmdzIjoiOzs7Ozs7QUFRSUEsUUFBTTtBQUFBO0FBQUE7QUFBQTs7QUFDSkMsY0FBVSxFQUROO0FBRUpDLFlBQVEsS0FGSjtBQUdKQyxhQUFTLEtBSEw7QUFJSkMsYUFBUztBQUpMLEc7QUFNTkMsVUFBUSxrQkFBWTtBQUNsQixTQUFLQyxPQUFMLENBQWE7QUFDWEwsZ0JBQVUsRUFEQztBQUVYQyxjQUFRLEtBRkc7QUFHWEMsZUFBUyxLQUhFO0FBSVhDLGVBQVM7QUFKRSxLQUFiO0FBTUQsRzs7QUFFREcsZ0IsMEJBQWVDLEcsRUFBSztBQUFBOztBQUNsQixRQUFJQyxRQUFRLElBQVo7QUFDQSxRQUFJLENBQUNELElBQUlFLE1BQUosQ0FBV0MsRUFBaEIsRUFBb0I7QUFDbEJDLFNBQUdDLFNBQUgsQ0FBYTtBQUNY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QUlHYyxLQUpILENBSVM7QUFBQSxhQUFTakIsR0FBR0MsU0FBSCxDQUFhLEVBQUNDLE9BQU80QixNQUFNaEMsTUFBTixJQUFnQixVQUF4QixFQUFvQ0ssTUFBTSxNQUExQyxFQUFiLENBQVQ7QUFBQSxLQUpUO0FBS0QiLCJmaWxlIjoiaW5kZXgud3hwIiwic291cmNlc0NvbnRlbnQiOlsiZXhwb3J0IGRlZmF1bHQge1xuICAgIGNvbmZpZzoge1xuICAgICAgbmF2aWdhdGlvbkJhclRpdGxlVGV4dDogJ+eZu+W9lScsXG4gICAgICBuYXZpZ2F0aW9uQmFyQmFja2dyb3VuZENvbG9yOiAnI0ZGRENFNCcsXG4gICAgICB1c2luZ0NvbXBvbmVudHM6IHtcbiAgICAgICAgJ3d4Yy1hdmF0YXInOiAnQG1pbnVpL3d4Yy1hdmF0YXInLFxuICAgICAgfVxuICAgIH0sXG4gICAgZGF0YToge1xuICAgICAgdXNlckluZm86IHt9LFxuICAgICAgYXV0aGVkOiBmYWxzZSxcbiAgICAgIGxvYWRpbmc6IGZhbHNlLFxuICAgICAgbm9QaG9uZTogZmFsc2VcbiAgICB9LFxuICAgIG9uU2hvdzogZnVuY3Rpb24gKCkge1xuICAgICAgdGhpcy5zZXREYXRhKHtcbiAgICAgICAgdXNlckluZm86IHt9LFxuICAgICAgICBhdXRoZWQ6IGZhbHNlLFxuICAgICAgICBsb2FkaW5nOiBmYWxzZSxcbiAgICAgICAgbm9QaG9uZTogZmFsc2VcbiAgICAgIH0pXG4gICAgfSxcblxuICAgIGdldFBob25lTnVtYmVyKHJlcykge1xuICAgICAgbGV0IF90aGlzID0gdGhpcztcbiAgICAgIGlmICghcmVzLmRldGFpbC5pdikge1xuICAgICAgICB3eC5zaG93VG9hc3Qoe1xuICAgICAgICAgIHRpdGxlOiAn6I635Y+W5omL5py65Y+35aSx6LSl77yM6K+36YeN6K+VJyxcbiAgICAgICAgICBpY29uOiAnbm9uZSdcbiAgICAgICAgfSlcbiAgICAgICAgcmV0dXJuXG4gICAgICB9XG4gICAgICBcbiAgICAgIGNvbnN0IGFwcCA9IGdldEFwcCgpXG5cbiAgICAgIC8vIHJlcy5kZXRhaWxcbiAgICAgIC8vIGVuY3J5cHRlZERhdGE6IFwiM2FLVExiTmxWalNOU1FpTU83cEtwbUI2T2tSRDV1OGg4akwreTJBcDJ2QnltTFVzTlY2cXpLcE9HK3QwVGVhc1dFS3FraTJVOStnNDc3bUZpY0dxMFBJWjBERTh0QnBTSzdCZnQrdmdHMlpVd0JFMkYvWHoyOGJhWmNGVlNoSWd4bzFIYlVEVkJDSTI1TTNMVFhlTXFubkZ1QTJFb0diTXR2dTR0VHpENmNicVBacEVTdUxsUU02bzFRa3dZdTczZnp1bVY2Vm5hNmlVbHQ1cHNVdWlvQT09XCJcbiAgICAgIC8vIGVyck1zZzogXCJnZXRQaG9uZU51bWJlcjpva1wiXG4gICAgICAvLyBpdjogXCJtWU80OFRPbWU1d1BNdzFlN1JTNFNnPT1cIlxuXG4gICAgICBhcHAucG9zdCgnYmluZC9iaW5kTWUnLCB7XG4gICAgICAgIGVuY19kZXRhaWw6IEpTT04uc3RyaW5naWZ5KHJlcy5kZXRhaWwpLFxuICAgICAgICB1c2VyX2luZm86IEpTT04uc3RyaW5naWZ5KHRoaXMuZGF0YS51c2VySW5mbylcbiAgICAgIH0pLnRoZW4oZGF0YSA9PiB7XG4gICAgICAgIGFwcC5nbG9iYWxEYXRhLm5vUGhvbmUgPSBmYWxzZVxuICAgICAgICBsZXQgdXNlckluZm8gPSB0aGlzLmRhdGEudXNlckluZm9cbiAgICAgICAgdXNlckluZm8ubm9QaG9uZSA9IGZhbHNlXG5cbiAgICAgICAgLy8g6ZqQ6JePXG4gICAgICAgIHRoaXMuc2V0RGF0YSh7XG4gICAgICAgICAgbm9QaG9uZTogZmFsc2VcbiAgICAgICAgfSlcblxuICAgICAgICBhcHAuc2V0VXNlckluZm8odXNlckluZm8pXG5cbiAgICAgICAgd3gubmF2aWdhdGVCYWNrKClcbiAgICAgIH0pXG5cbiAgICB9LFxuXG4gICAgZ2V0VXNlckluZm8ocmVzKSB7XG4gICAgICBjb25zdCBhcHAgPSBnZXRBcHAoKVxuXG4gICAgICBhcHAubG9naW4oKS50aGVuKGRhdGEgPT4geyAvLyBkYXRhIOS4unNlc3Npb25faWRcbiAgICAgICAgaWYgKCFyZXMuZGV0YWlsLnVzZXJJbmZvKSB7XG4gICAgICAgICAgcmV0dXJuIHd4LnNob3dUb2FzdCh7XG4gICAgICAgICAgICB0aXRsZTogJ+ivt+aCqOWFiOaOiOadgycsXG4gICAgICAgICAgICBpY29uOiAnbm9uZSdcbiAgICAgICAgICB9KVxuICAgICAgICB9XG5cbiAgICAgICAgLy8g6I635Y+W5LqG55So5oi35L+h5oGvXG4gICAgICAgIGNvbnN0IHVzZXJJbmZvID0gcmVzLmRldGFpbC51c2VySW5mb1xuICAgICAgICB1c2VySW5mby5ub1Bob25lID0gZGF0YS5ub1Bob25lXG4gICAgICAgIFxuICAgICAgICB0aGlzLnNldERhdGEoe1xuICAgICAgICAgIGF1dGhlZDogdHJ1ZSxcbiAgICAgICAgICBub1Bob25lOiBkYXRhLm5vUGhvbmUsXG4gICAgICAgICAgdXNlckluZm9cbiAgICAgICAgfSlcblxuICAgICAgICAgYXBwLnNldFVzZXJJbmZvKHVzZXJJbmZvKVxuXG4gICAgICAgIC8vIOacieaJi+acuuWPt++8jOebtOaOpei/lOWbnlxuICAgICAgICBpZiAoIWRhdGEubm9QaG9uZSkge1xuICAgICAgICAgIGFwcC5nbG9iYWxEYXRhLm5vUGhvbmUgPSBmYWxzZVxuICAgICAgICAgIHd4Lm5hdmlnYXRlQmFjaygpXG4gICAgICAgIH1cblxuICAgICAgfSkuY2F0Y2goZSA9PiB7XG4gICAgICAgIHd4LnNob3dUb2FzdCh7XG4gICAgICAgICAgdGl0bGU6ICfnmbvlvZXlpLHotKXvvIzor7fph43or5UnLFxuICAgICAgICAgIGljb246ICdub25lJ1xuICAgICAgICB9KVxuICAgICAgfSlcblxuXG4gICAgICBcblxuICAgICAgXG4gICAgfSwgIFxuICAgIGhhbmRsZXJQaG9uZTogZnVuY3Rpb24gKGV2ZW50KSB7XG4gICAgICBsZXQgdmFsdWUgPSBldmVudC5kZXRhaWwudmFsdWVcbiAgICAgIHRoaXMuc2V0RGF0YSh7XG4gICAgICAgIHBob25lOiB2YWx1ZVxuICAgICAgfSlcbiAgICB9LFxuICAgIGhhbmRsZXJTbXNDb2RlOiBmdW5jdGlvbiAoZXZlbnQpIHtcbiAgICAgIGxldCB2YWx1ZSA9IGV2ZW50LmRldGFpbC52YWx1ZVxuICAgICAgdGhpcy5zZXREYXRhKHtcbiAgICAgICAgc21zQ29kZTogdmFsdWVcbiAgICAgIH0pXG4gICAgfSxcbiAgICBsb2dpbjogZnVuY3Rpb24gKCkge1xuICAgICAgbGV0IGFwcCA9IGdldEFwcCgpXG4gICAgICBpZiAoIXRoaXMuZGF0YS5zbXNDb2RlIHx8ICEvXlxcZHs2fSQvLnRlc3QodGhpcy5kYXRhLnNtc0NvZGUpKSB7XG4gICAgICAgIHd4LnNob3dUb2FzdCh7XG4gICAgICAgICAgdGl0bGU6ICfpqozor4HnoIHplJnor68nLFxuICAgICAgICAgIGljb246ICdub25lJ1xuICAgICAgICB9KTtcbiAgICAgICAgcmV0dXJuXG4gICAgICB9XG5cbiAgICAgIGFwcC5nZXQoJ2JpbmQvYmluZE1lJywge2NvZGU6IHRoaXMuZGF0YS5zbXNDb2RlLCBwaG9uZTogdGhpcy5kYXRhLnBob25lLCB1c2VyX2luZm86IHRoaXMuZGF0YS51c2VySW5mb30pXG4gICAgICAgIC50aGVuKGRhdGEgPT4gc2V0VGltZW91dCgoKSA9PlxuICAgICAgICAgICAgd3guc3dpdGNoVGFiKHtcbiAgICAgICAgICAgICAgdXJsOiAnL3BhZ2VzL2FwcG9pbnRtZW50L2luZGV4J1xuICAgICAgICAgICAgfSlcbiAgICAgICAgICAsIDUwMCkpXG4gICAgICAgIC5jYXRjaChlcnJvciA9PlxuICAgICAgICAgIHd4LnNob3dUb2FzdCh7XG4gICAgICAgICAgICB0aXRsZTogZXJyb3IuZGV0YWlsIHx8ICfnmbvlvZXlpLHotKXvvIzor7fph43or5UnLFxuICAgICAgICAgICAgaWNvbjogJ25vbmUnXG4gICAgICAgICAgfSkpXG4gICAgfSxcbiAgICBzZW5kQ29kZTogZnVuY3Rpb24gKCkge1xuICAgICAgbGV0IGFwcCA9IGdldEFwcCgpXG5cbiAgICAgIGlmICghdGhpcy5kYXRhLnBob25lIHx8ICEvXjFcXGR7MTB9JC8udGVzdCh0aGlzLmRhdGEucGhvbmUpKSB7XG4gICAgICAgIHd4LnNob3dUb2FzdCh7XG4gICAgICAgICAgdGl0bGU6ICfmiYvmnLrlj7fmoLzlvI/plJnor68nLFxuICAgICAgICAgIGljb246ICdub25lJ1xuICAgICAgICB9KTtcbiAgICAgICAgcmV0dXJuXG4gICAgICB9XG5cbiAgICAgIHRoaXMuc2V0RGF0YSh7XG4gICAgICAgIHN0YXJ0OiB0cnVlXG4gICAgICB9KVxuXG4gICAgICBsZXQgaW50ZXJ2YWxDb3VudHMgPSA2MFxuXG4gICAgICB0aGlzLnNldERhdGEoe1xuICAgICAgICBzdGFydFRleHQ6IGAke2ludGVydmFsQ291bnRzLS19c2BcbiAgICAgIH0pXG5cbiAgICAgIGxldCBpbnRlcnZhbCA9IHNldEludGVydmFsKHggPT4ge1xuICAgICAgICB0aGlzLnNldERhdGEoe1xuICAgICAgICAgIHN0YXJ0VGV4dDogYCR7aW50ZXJ2YWxDb3VudHMtLX1zYFxuICAgICAgICB9KVxuXG4gICAgICAgIGlmIChpbnRlcnZhbENvdW50cyA9PSAtMSkge1xuICAgICAgICAgIGNsZWFySW50ZXJ2YWwoaW50ZXJ2YWwpXG4gICAgICAgICAgdGhpcy5zZXREYXRhKHtcbiAgICAgICAgICAgIHN0YXJ0OiBmYWxzZSxcbiAgICAgICAgICAgIHN0YXJ0VGV4dDogJ+WPkemAgemqjOivgeeggSdcbiAgICAgICAgICB9KVxuICAgICAgICB9XG4gICAgICB9LCAxMDAwKVxuXG4gICAgICBhcHAuZ2V0KGBzbXMvc2VuZC8ke3RoaXMuZGF0YS5waG9uZX1gKVxuICAgICAgICAudGhlbihkYXRhID0+IHtcbiAgICAgICAgICB3eC5zaG93VG9hc3Qoe3RpdGxlOiAn6aqM6K+B56CB5bey5Y+R6YCB77yM6K+35rOo5oSP5p+l5pS2JywgaWNvbjogJ25vbmUnfSlcbiAgICAgICAgfSlcbiAgICAgICAgLmNhdGNoKGVycm9yID0+IHd4LnNob3dUb2FzdCh7dGl0bGU6IGVycm9yLmRldGFpbCB8fCAn55m75b2V5aSx6LSl77yM6K+36YeN6K+VJywgaWNvbjogJ25vbmUnfSkpXG4gICAgfSxcbiAgfSJdfQ==