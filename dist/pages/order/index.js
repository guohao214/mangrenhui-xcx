'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = Page({
  data: {
    '__code__': {
      readme: ''
    },

    orderType: '',
    orderId: '',
    lastComponent: '',
    orderList: [],
    payType: '',
    beauticianCode: '', // 技师工号
    couponCode: '' // 优惠券
  },
  onLoad: function onLoad(options) {
    console.log(options);
  },
  onShow: function onShow() {
    this.getOrderList();
  },
  getOrderList: function getOrderList() {
    var _this = this;

    var app = getApp();
    app.get('center/order').then(function (data) {
      var result = data.data;
      result.content.forEach(function (item) {
        return item.appointment_end_time = _this._realDay(item.appointment_day, item.appointment_end_time);
      });
      _this.setData({
        orderList: result.content
      });
    });
  },
  payOffline: function payOffline() {
    var _this2 = this;

    var app = getApp();
    if (this.data.payType === 'cash') {
      if (this.data.beauticianCode.trim().length === 0) {
        wx.showToast({
          title: '技师工号不能为空',
          icon: 'none'
        });

        return;
      }
    }

    // 团购
    if (this.data.payType === 'group') {
      if (!this.data.couponCode.match(/^\d{6,}$/)) {
        wx.showToast({
          title: '券号输入错误',
          icon: 'none'
        });

        return;
      }
    }

    app.post('center/completeOrder/' + this.data.orderId, {
      type: this.data.payType,
      beautician_code: this.data.beauticianCode, coupon_code: this.data.couponCode
    }).then(function () {
      _this2.getOrderList();
      _this2.data.lastComponent.hide();
      _this2.setData({
        orderId: '',
        orderNo: '',
        lastComponent: '',
        payType: '',
        beauticianCode: '', // 技师工号
        couponCode: '' // 优惠券
      });
    }).catch(function (error) {
      wx.showToast({
        title: error.detail || '支付失败，请重试',
        duration: 2000,
        icon: 'none'
      });
    });
  },
  payOnline: function payOnline() {
    var app = getApp();
    app.get('order/pay/' + this.data.orderNo).then(function (data) {
      var result = data.data;
      var payParams = {
        'success': function success(res) {
          var _this3 = this;

          wx.showToast({
            title: '支付成功,等待数据确认，请稍等...',
            duration: 3000,
            icon: 'none'
          });

          setTimeout(function (x) {
            return _this3.getOrderList();
          }, 2000);
        },
        'fail': function fail(res) {
          wx.showToast({
            title: '支付失败, 请重试...',
            duration: 2000,
            icon: 'none'
          });
        }
      };

      Object.assign(payParams, result.content);

      wx.requestPayment(payParams);
    }).catch(function (error) {
      wx.showToast({
        title: error.detail || '支付失败，请重试',
        duration: 2000,
        icon: 'none'
      });
    });
  },
  cash: function cash(event) {
    var id = event.currentTarget.dataset.id;
    this.setData({
      payType: 'cash',
      orderId: id
    });
    var dialogComponent = this.data.lastComponent = this.selectComponent('.wxc-cash');
    dialogComponent && dialogComponent.show();
  },
  handlerBeautician: function handlerBeautician(event) {
    var value = event.detail.value;
    this.setData({
      beauticianCode: value
    });
  },
  handlerCouponCode: function handlerCouponCode(event) {
    var value = event.detail.value;
    this.setData({
      couponCode: value
    });
  },
  scan: function scan(event) {
    var id = event.currentTarget.dataset.id;
    this.setData({
      payType: 'scan',
      orderId: id
    });
    var dialogComponent = this.data.lastComponent = this.selectComponent('.wxc-scan');
    dialogComponent && dialogComponent.show();
  },
  groupBy: function groupBy(event) {
    var id = event.currentTarget.dataset.id;
    this.setData({
      payType: 'group',
      orderId: id
    });
    var dialogComponent = this.data.lastComponent = this.selectComponent('.wxc-group');
    dialogComponent && dialogComponent.show();
  },
  online: function online(event) {
    var orderNo = event.currentTarget.dataset.id;
    this.setData({
      payType: 'online',
      orderNo: orderNo
    });
    var dialogComponent = this.data.lastComponent = this.selectComponent('.wxc-online');
    dialogComponent && dialogComponent.show();
  },
  cancel: function cancel() {
    this.data.lastComponent.hide();
  },
  cancelOrder: function cancelOrder(event) {
    var _this4 = this;

    var app = getApp();
    var orderId = event.currentTarget.dataset.id;
    var index = event.currentTarget.dataset.index;
    app.get('center/cancelOrder/' + orderId).then(function () {
      var orderList = _this4.data.orderList;
      orderList[index].order_status = 2;
      _this4.setData({
        orderList: orderList
      });
    }).catch(function (error) {});
  },
  _realDay: function _realDay(value, day) {
    try {
      var _day = day + ' ' + value;
      _day = _day.replace(/-/g, '/');
      var date = new Date(_day).getTime() + 30 * 60 * 1000;
      var date = new Date(date);
      var minute = date.getMinutes();
      if (minute.toString().length == 1) minute += '0';
      return date.getHours() + ':' + minute + ':00';
    } catch (e) {
      return value;
    }
  }

});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImluZGV4Lnd4cCJdLCJuYW1lcyI6WyJkYXRhIiwib3JkZXJUeXBlIiwib3JkZXJJZCIsImxhc3RDb21wb25lbnQiLCJvcmRlckxpc3QiLCJwYXlUeXBlIiwiYmVhdXRpY2lhbkNvZGUiLCJjb3Vwb25Db2RlIiwib25Mb2FkIiwib3B0aW9ucyIsImNvbnNvbGUiLCJsb2ciLCJvblNob3ciLCJnZXRPcmRlckxpc3QiLCJhcHAiLCJnZXRBcHAiLCJnZXQiLCJ0aGVuIiwicmVzdWx0IiwiY29udGVudCIsImZvckVhY2giLCJpdGVtIiwiYXBwb2ludG1lbnRfZW5kX3RpbWUiLCJfcmVhbERheSIsImFwcG9pbnRtZW50X2RheSIsInNldERhdGEiLCJwYXlPZmZsaW5lIiwidHJpbSIsImxlbmd0aCIsInd4Iiwic2hvd1RvYXN0IiwidGl0bGUiLCJpY29uIiwibWF0Y2giLCJwb3N0IiwidHlwZSIsImJlYXV0aWNpYW5fY29kZSIsImNvdXBvbl9jb2RlIiwiaGlkZSIsIm9yZGVyTm8iLCJjYXRjaCIsImVycm9yIiwiZGV0YWlsIiwiZHVyYXRpb24iLCJwYXlPbmxpbmUiLCJwYXlQYXJhbXMiLCJyZXMiLCJzZXRUaW1lb3V0IiwiT2JqZWN0IiwiYXNzaWduIiwicmVxdWVzdFBheW1lbnQiLCJjYXNoIiwiZXZlbnQiLCJpZCIsImN1cnJlbnRUYXJnZXQiLCJkYXRhc2V0IiwiZGlhbG9nQ29tcG9uZW50Iiwic2VsZWN0Q29tcG9uZW50Iiwic2hvdyIsImhhbmRsZXJCZWF1dGljaWFuIiwidmFsdWUiLCJoYW5kbGVyQ291cG9uQ29kZSIsInNjYW4iLCJncm91cEJ5Iiwib25saW5lIiwiY2FuY2VsIiwiY2FuY2VsT3JkZXIiLCJpbmRleCIsIm9yZGVyX3N0YXR1cyIsImRheSIsIl9kYXkiLCJyZXBsYWNlIiwiZGF0ZSIsIkRhdGUiLCJnZXRUaW1lIiwibWludXRlIiwiZ2V0TWludXRlcyIsInRvU3RyaW5nIiwiZ2V0SG91cnMiLCJlIl0sIm1hcHBpbmdzIjoiOzs7Ozs7QUFP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LE1BQXhCLEdBQWlDLEtBQXhDO0FBQ0QsS0FURCxDQVNFLE9BQU9JLENBQVAsRUFBVTtBQUNWLGFBQU9uQixLQUFQO0FBQ0Q7QUFDRiIsImZpbGUiOiJpbmRleC53eHAiLCJzb3VyY2VzQ29udGVudCI6WyJleHBvcnQgZGVmYXVsdCB7XG4gICAgY29uZmlnOiB7XG4gICAgICBuYXZpZ2F0aW9uQmFyVGl0bGVUZXh0OiAn5oiR55qE6K6i5Y2VJyxcbiAgICAgIHVzaW5nQ29tcG9uZW50czoge1xuICAgICAgICAnd3hjLWRpYWxvZyc6ICdAbWludWkvd3hjLWRpYWxvZydcbiAgICAgIH1cbiAgICB9LFxuICAgIGRhdGE6IHtcbiAgICAgIG9yZGVyVHlwZTogJycsXG4gICAgICBvcmRlcklkOiAnJyxcbiAgICAgIGxhc3RDb21wb25lbnQ6ICcnLFxuICAgICAgb3JkZXJMaXN0OiBbXSxcbiAgICAgIHBheVR5cGU6ICcnLFxuICAgICAgYmVhdXRpY2lhbkNvZGU6ICcnLCAgLy8g5oqA5biI5bel5Y+3XG4gICAgICBjb3Vwb25Db2RlOiAnJyAgICAgICAvLyDkvJjmg6DliLhcbiAgICB9LFxuICAgIG9uTG9hZDogZnVuY3Rpb24gKG9wdGlvbnMpIHtcbiAgICAgIGNvbnNvbGUubG9nKG9wdGlvbnMpXG4gICAgfSxcbiAgICBvblNob3c6IGZ1bmN0aW9uICgpIHtcbiAgICAgIHRoaXMuZ2V0T3JkZXJMaXN0KClcbiAgICB9LFxuICAgIGdldE9yZGVyTGlzdDogZnVuY3Rpb24gKCkge1xuICAgICAgbGV0IGFwcCA9IGdldEFwcCgpXG4gICAgICBhcHAuZ2V0KCdjZW50ZXIvb3JkZXInKS50aGVuKGRhdGEgPT4ge1xuICAgICAgICBsZXQgcmVzdWx0ID0gZGF0YS5kYXRhXG4gICAgICAgIHJlc3VsdC5jb250ZW50LmZvckVhY2goaXRlbSA9PiBpdGVtLmFwcG9pbnRtZW50X2VuZF90aW1lID0gdGhpcy5fcmVhbERheShpdGVtLmFwcG9pbnRtZW50X2RheSwgaXRlbS5hcHBvaW50bWVudF9lbmRfdGltZSkpXG4gICAgICAgIHRoaXMuc2V0RGF0YSh7XG4gICAgICAgICAgb3JkZXJMaXN0OiByZXN1bHQuY29udGVudFxuICAgICAgICB9KVxuICAgICAgfSlcbiAgICB9LFxuICAgIHBheU9mZmxpbmU6IGZ1bmN0aW9uICgpIHtcbiAgICAgIGxldCBhcHAgPSBnZXRBcHAoKVxuICAgICAgaWYgKHRoaXMuZGF0YS5wYXlUeXBlID09PSAnY2FzaCcpIHtcbiAgICAgICAgaWYgKHRoaXMuZGF0YS5iZWF1dGljaWFuQ29kZS50cmltKCkubGVuZ3RoID09PSAwKSB7XG4gICAgICAgICAgd3guc2hvd1RvYXN0KHtcbiAgICAgICAgICAgIHRpdGxlOiAn5oqA5biI5bel5Y+35LiN6IO95Li656m6JyxcbiAgICAgICAgICAgIGljb246ICdub25lJ1xuICAgICAgICAgIH0pXG5cbiAgICAgICAgICByZXR1cm5cbiAgICAgICAgfVxuICAgICAgfVxuXG4gICAgICAvLyDlm6LotK1cbiAgICAgIGlmICh0aGlzLmRhdGEucGF5VHlwZSA9PT0gJ2dyb3VwJykge1xuICAgICAgICBpZiAoIXRoaXMuZGF0YS5jb3Vwb25Db2RlLm1hdGNoKC9eXFxkezYsfSQvKSkge1xuICAgICAgICAgIHd4LnNob3dUb2FzdCh7XG4gICAgICAgICAgICB0aXRsZTogJ+WIuOWPt+i+k+WFpemUmeivrycsXG4gICAgICAgICAgICBpY29uOiAnbm9uZSdcbiAgICAgICAgICB9KVxuXG4gICAgICAgICAgcmV0dXJuXG4gICAgICAgIH1cbiAgICAgIH1cblxuXG4gICAgICBhcHAucG9zdChgY2VudGVyL2NvbXBsZXRlT3JkZXIvJHt0aGlzLmRhdGEub3JkZXJJZH1gLCB7XG4gICAgICAgIHR5cGU6IHRoaXMuZGF0YS5wYXlUeXBlLFxuICAgICAgICBiZWF1dGljaWFuX2NvZGU6IHRoaXMuZGF0YS5iZWF1dGljaWFuQ29kZSwgY291cG9uX2NvZGU6IHRoaXMuZGF0YS5jb3Vwb25Db2RlXG4gICAgICB9KS50aGVuKCgpID0+IHtcbiAgICAgICAgdGhpcy5nZXRPcmRlckxpc3QoKVxuICAgICAgICB0aGlzLmRhdGEubGFzdENvbXBvbmVudC5oaWRlKClcbiAgICAgICAgdGhpcy5zZXREYXRhKHtcbiAgICAgICAgICBvcmRlcklkOiAnJyxcbiAgICAgICAgICBvcmRlck5vOiAnJyxcbiAgICAgICAgICBsYXN0Q29tcG9uZW50OiAnJyxcbiAgICAgICAgICBwYXlUeXBlOiAnJyxcbiAgICAgICAgICBiZWF1dGljaWFuQ29kZTogJycsICAvLyDmioDluIjlt6Xlj7dcbiAgICAgICAgICBjb3Vwb25Db2RlOiAnJyAgICAgICAvLyDkvJjmg6DliLhcbiAgICAgICAgfSlcbiAgICAgIH0pXG4gICAgICAgIC5jYXRjaChlcnJvciA9PiB7XG4gICAgICAgICAgd3guc2hvd1RvYXN0KHtcbiAgICAgICAgICAgIHRpdGxlOiBlcnJvci5kZXRhaWwgfHwgJ+aUr+S7mOWksei0pe+8jOivt+mHjeivlScsXG4gICAgICAgICAgICBkdXJhdGlvbjogMjAwMCxcbiAgICAgICAgICAgIGljb246ICdub25lJ1xuICAgICAgICAgIH0pXG4gICAgICAgIH0pXG4gICAgfSxcbiAgICBwYXlPbmxpbmU6IGZ1bmN0aW9uICgpIHtcbiAgICAgIGxldCBhcHAgPSBnZXRBcHAoKVxuICAgICAgYXBwLmdldChgb3JkZXIvcGF5LyR7dGhpcy5kYXRhLm9yZGVyTm99YClcbiAgICAgICAgLnRoZW4oZGF0YSA9PiB7XG4gICAgICAgICAgbGV0IHJlc3VsdCA9IGRhdGEuZGF0YVxuICAgICAgICAgIGxldCBwYXlQYXJhbXMgPSB7XG4gICAgICAgICAgICAnc3VjY2Vzcyc6IGZ1bmN0aW9uIChyZXMpIHtcblxuICAgICAgICAgICAgICB3eC5zaG93VG9hc3Qoe1xuICAgICAgICAgICAgICAgIHRpdGxlOiAn5pSv5LuY5oiQ5YqfLOetieW+heaVsOaNruehruiupO+8jOivt+eojeetiS4uLicsXG4gICAgICAgICAgICAgICAgZHVyYXRpb246IDMwMDAsXG4gICAgICAgICAgICAgICAgaWNvbjogJ25vbmUnXG4gICAgICAgICAgICAgIH0pXG5cbiAgICAgICAgICAgICAgc2V0VGltZW91dCh4ID0+IHRoaXMuZ2V0T3JkZXJMaXN0KCksIDIwMDApXG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgJ2ZhaWwnOiBmdW5jdGlvbiAocmVzKSB7XG4gICAgICAgICAgICAgIHd4LnNob3dUb2FzdCh7XG4gICAgICAgICAgICAgICAgdGl0bGU6ICfmlK/ku5jlpLHotKUsIOivt+mHjeivlS4uLicsXG4gICAgICAgICAgICAgICAgZHVyYXRpb246IDIwMDAsXG4gICAgICAgICAgICAgICAgaWNvbjogJ25vbmUnXG4gICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICB9XG4gICAgICAgICAgfVxuXG4gICAgICAgICAgT2JqZWN0LmFzc2lnbihwYXlQYXJhbXMsIHJlc3VsdC5jb250ZW50KVxuXG4gICAgICAgICAgd3gucmVxdWVzdFBheW1lbnQocGF5UGFyYW1zKVxuICAgICAgICB9KVxuICAgICAgICAuY2F0Y2goZXJyb3IgPT4ge1xuICAgICAgICAgIHd4LnNob3dUb2FzdCh7XG4gICAgICAgICAgICB0aXRsZTogZXJyb3IuZGV0YWlsIHx8ICfmlK/ku5jlpLHotKXvvIzor7fph43or5UnLFxuICAgICAgICAgICAgZHVyYXRpb246IDIwMDAsXG4gICAgICAgICAgICBpY29uOiAnbm9uZSdcbiAgICAgICAgICB9KVxuICAgICAgICB9KVxuICAgIH0sXG4gICAgY2FzaDogZnVuY3Rpb24gKGV2ZW50KSB7XG4gICAgICBsZXQgaWQgPSBldmVudC5jdXJyZW50VGFyZ2V0LmRhdGFzZXQuaWRcbiAgICAgIHRoaXMuc2V0RGF0YSh7XG4gICAgICAgIHBheVR5cGU6ICdjYXNoJyxcbiAgICAgICAgb3JkZXJJZDogaWQsXG4gICAgICB9KVxuICAgICAgbGV0IGRpYWxvZ0NvbXBvbmVudCA9IHRoaXMuZGF0YS5sYXN0Q29tcG9uZW50ID0gdGhpcy5zZWxlY3RDb21wb25lbnQoJy53eGMtY2FzaCcpXG4gICAgICBkaWFsb2dDb21wb25lbnQgJiYgZGlhbG9nQ29tcG9uZW50LnNob3coKTtcbiAgICB9LFxuICAgIGhhbmRsZXJCZWF1dGljaWFuOiBmdW5jdGlvbiAoZXZlbnQpIHtcbiAgICAgIGxldCB2YWx1ZSA9IGV2ZW50LmRldGFpbC52YWx1ZVxuICAgICAgdGhpcy5zZXREYXRhKHtcbiAgICAgICAgYmVhdXRpY2lhbkNvZGU6IHZhbHVlXG4gICAgICB9KVxuICAgIH0sXG4gICAgaGFuZGxlckNvdXBvbkNvZGU6IGZ1bmN0aW9uIChldmVudCkge1xuICAgICAgbGV0IHZhbHVlID0gZXZlbnQuZGV0YWlsLnZhbHVlXG4gICAgICB0aGlzLnNldERhdGEoe1xuICAgICAgICBjb3Vwb25Db2RlOiB2YWx1ZVxuICAgICAgfSlcbiAgICB9LFxuICAgIHNjYW46IGZ1bmN0aW9uIChldmVudCkge1xuICAgICAgbGV0IGlkID0gZXZlbnQuY3VycmVudFRhcmdldC5kYXRhc2V0LmlkXG4gICAgICB0aGlzLnNldERhdGEoe1xuICAgICAgICBwYXlUeXBlOiAnc2NhbicsXG4gICAgICAgIG9yZGVySWQ6IGlkXG4gICAgICB9KVxuICAgICAgbGV0IGRpYWxvZ0NvbXBvbmVudCA9IHRoaXMuZGF0YS5sYXN0Q29tcG9uZW50ID0gdGhpcy5zZWxlY3RDb21wb25lbnQoJy53eGMtc2NhbicpXG4gICAgICBkaWFsb2dDb21wb25lbnQgJiYgZGlhbG9nQ29tcG9uZW50LnNob3coKTtcbiAgICB9LFxuICAgIGdyb3VwQnk6IGZ1bmN0aW9uIChldmVudCkge1xuICAgICAgbGV0IGlkID0gZXZlbnQuY3VycmVudFRhcmdldC5kYXRhc2V0LmlkXG4gICAgICB0aGlzLnNldERhdGEoe1xuICAgICAgICBwYXlUeXBlOiAnZ3JvdXAnLFxuICAgICAgICBvcmRlcklkOiBpZFxuICAgICAgfSlcbiAgICAgIGxldCBkaWFsb2dDb21wb25lbnQgPSB0aGlzLmRhdGEubGFzdENvbXBvbmVudCA9IHRoaXMuc2VsZWN0Q29tcG9uZW50KCcud3hjLWdyb3VwJylcbiAgICAgIGRpYWxvZ0NvbXBvbmVudCAmJiBkaWFsb2dDb21wb25lbnQuc2hvdygpO1xuICAgIH0sXG4gICAgb25saW5lOiBmdW5jdGlvbiAoZXZlbnQpIHtcbiAgICAgIGxldCBvcmRlck5vID0gZXZlbnQuY3VycmVudFRhcmdldC5kYXRhc2V0LmlkXG4gICAgICB0aGlzLnNldERhdGEoe1xuICAgICAgICBwYXlUeXBlOiAnb25saW5lJyxcbiAgICAgICAgb3JkZXJObzogb3JkZXJOb1xuICAgICAgfSlcbiAgICAgIGxldCBkaWFsb2dDb21wb25lbnQgPSB0aGlzLmRhdGEubGFzdENvbXBvbmVudCA9IHRoaXMuc2VsZWN0Q29tcG9uZW50KCcud3hjLW9ubGluZScpXG4gICAgICBkaWFsb2dDb21wb25lbnQgJiYgZGlhbG9nQ29tcG9uZW50LnNob3coKTtcbiAgICB9LFxuICAgIGNhbmNlbDogZnVuY3Rpb24gKCkge1xuICAgICAgdGhpcy5kYXRhLmxhc3RDb21wb25lbnQuaGlkZSgpO1xuICAgIH0sXG4gICAgY2FuY2VsT3JkZXI6IGZ1bmN0aW9uIChldmVudCkge1xuICAgICAgbGV0IGFwcCA9IGdldEFwcCgpXG4gICAgICBsZXQgb3JkZXJJZCA9IGV2ZW50LmN1cnJlbnRUYXJnZXQuZGF0YXNldC5pZFxuICAgICAgbGV0IGluZGV4ID0gZXZlbnQuY3VycmVudFRhcmdldC5kYXRhc2V0LmluZGV4XG4gICAgICBhcHAuZ2V0KCdjZW50ZXIvY2FuY2VsT3JkZXIvJyArIG9yZGVySWQpXG4gICAgICAgIC50aGVuKCgpID0+IHtcbiAgICAgICAgICBsZXQgb3JkZXJMaXN0ID0gdGhpcy5kYXRhLm9yZGVyTGlzdFxuICAgICAgICAgIG9yZGVyTGlzdFtpbmRleF0ub3JkZXJfc3RhdHVzID0gMlxuICAgICAgICAgIHRoaXMuc2V0RGF0YSh7XG4gICAgICAgICAgICBvcmRlckxpc3Q6IG9yZGVyTGlzdFxuICAgICAgICAgIH0pXG4gICAgICAgIH0pXG4gICAgICAgIC5jYXRjaChlcnJvciA9PiB7XG4gICAgICAgIH0pXG4gICAgfSxcbiAgICBfcmVhbERheTogZnVuY3Rpb24gKHZhbHVlLCBkYXkpIHtcbiAgICAgIHRyeSB7XG4gICAgICAgIHZhciBfZGF5ID0gZGF5ICsgJyAnICsgdmFsdWVcbiAgICAgICAgX2RheSA9IF9kYXkucmVwbGFjZSgvLS9nLCAnLycpXG4gICAgICAgIHZhciBkYXRlID0gKG5ldyBEYXRlKF9kYXkpKS5nZXRUaW1lKCkgKyAzMCAqIDYwICogMTAwMFxuICAgICAgICB2YXIgZGF0ZSA9IChuZXcgRGF0ZShkYXRlKSlcbiAgICAgICAgdmFyIG1pbnV0ZSA9IGRhdGUuZ2V0TWludXRlcygpXG4gICAgICAgIGlmIChtaW51dGUudG9TdHJpbmcoKS5sZW5ndGggPT0gMSlcbiAgICAgICAgICBtaW51dGUgKz0gJzAnXG4gICAgICAgIHJldHVybiBkYXRlLmdldEhvdXJzKCkgKyAnOicgKyBtaW51dGUgKyAnOjAwJ1xuICAgICAgfSBjYXRjaCAoZSkge1xuICAgICAgICByZXR1cm4gdmFsdWVcbiAgICAgIH1cbiAgICB9XG5cbiAgfSJdfQ==