'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});
var upload = require('../../common/upload.js');

exports.default = Page({
  data: {
    pet_class_id_index: '',
    sexs: ['公', '母'],
    babys: ['是', '否'],
    classs: [],
    pet: {
      pet_pic_url: '',
      pet_pic: '',
      pet_name: '',
      pet_class_id: '',
      pet_class_name: '',
      pet_sex: '',
      pet_sex_id: '',
      pet_will_have_baby: '',
      pet_will_have_baby_id: '',
      birthday: ''
    },
    pet_id: 0,
    isEdit: false,
    pets: []
  },
  onLoad: function onLoad(options) {
    var _this = this;

    var pet_id = (options.id || 0) / 1 || 0;
    this.setData({
      pet_id: pet_id,
      isEdit: !!pet_id
    }, function () {
      return _this.getClasss();
    });
  },

  chooseImage: function chooseImage() {
    var _this2 = this;

    upload(getApp()).then(function (data) {
      // data = json.jsonDecode(data)
      if (data.status == 0) return getApp().showToast('上传失败,请重试');

      var pic = data.data.content;
      debugger;
      _this2.setData({
        'pet.pet_pic_url': pic.url,
        'pet.pet_pic': pic.pic
      });
    });
  },
  getClasss: function getClasss() {
    var _this3 = this;

    getApp().get('pet/getPetClass').then(function (data) {
      var classs = data.data.content.map(function (item) {
        return {
          key: item.pet_class_id / 1,
          name: item.pet_class_name
        };
      });

      _this3.setData({
        classs: classs
      });
    }).then(function () {
      return _this3.getDetail();
    });
  },
  getDetail: function getDetail() {
    var _this4 = this;

    var self = this;

    if (this.data.isEdit) {
      getApp().get('pet/one?pet_id=' + this.data.pet_id).then(function (data) {
        var pet = data.data.content;

        pet.pet_id = pet.pet_id / 1;
        pet.pet_will_have_baby_id = pet.pet_will_have_baby_id / 1;
        pet.pet_class_id = pet.pet_class_id / 1;
        pet.pet_sex_id = pet.pet_sex_id / 1;

        var pet_class_id_index = _this4.data.classs.findIndex(function (item) {
          return item.key == pet.pet_class_id;
        });

        self.setData({
          pet_class_id_index: pet_class_id_index,
          pet: pet
        });
      });
    }
  },


  onShow: function onShow() {
    // this.getPets()
  },

  bindChangeName: function bindChangeName(e) {
    var k = e.detail.value;
    this.setData({
      'pet.pet_name': k
    });
  },
  deletePet: function deletePet() {
    var dialogComponent = this.data.lastComponent = this.selectComponent('.wxc-cancel-pet');
    dialogComponent && dialogComponent.show();
  },
  cancelDeletePet: function cancelDeletePet() {
    var dialogComponent = this.data.lastComponent = this.selectComponent('.wxc-cancel-pet');
    dialogComponent && dialogComponent.hide();
  },
  confirmDeletePet: function confirmDeletePet() {
    getApp().post('pet/removePet', {
      pet_id: this.data.pet_id
    }).then(function (data) {
      wx.navigateBack();
    });
  },
  bindChangeClass: function bindChangeClass(e) {
    var k = e.detail.value;
    var v = this.data.classs[k];
    this.setData({
      'pet_class_id_index': k,
      'pet.pet_class_id': v['key'],
      'pet.pet_class_name': v['name']
    });
  },
  bindChangeSex: function bindChangeSex(e) {
    var k = e.detail.value;
    var v = this.data.sexs[k];
    this.setData({
      'pet.pet_sex': v,
      'pet.pet_sex_id': k
    });
  },
  bindChangeBaby: function bindChangeBaby(e) {
    var k = e.detail.value;
    var v = this.data.babys[k];
    this.setData({
      'pet.pet_will_have_baby': v,
      'pet.pet_will_have_baby_id': k
    });
  },
  bindChangeDate: function bindChangeDate(e) {
    var k = e.detail.value;
    this.setData({
      'pet.birthday': k
    });
  },
  addPet: function addPet() {
    var app = getApp();
    var url = 'pet/createPet';
    if (this.data.isEdit) url = 'pet/updatePet?pet_id=' + this.data.pet_id;

    var pet = this.data.pet;
    if (!pet.pet_name.trim()) {
      return app.showToast('请输入猫咪昵称');
    }

    if (!pet.pet_class_id) {
      return app.showToast('请选择猫咪种类');
    }

    if (!String(pet.pet_sex_id).length) {
      return app.showToast('请选择性别');
    }

    if (!String(pet.pet_will_have_baby_id).length) {
      return app.showToast('请选择猫咪是否绝育');
    }

    if (!pet.birthday) {
      return app.showToast('请选择猫咪生日');
    }

    app.post(url, this.data.pet).then(function (data) {
      wx.navigateBack();
    });
  },


  getPets: function getPets() {
    var _this5 = this;

    var app = getApp();
    app.get('pet/findMyPets').then(function (data) {
      var result = data.data.content;
      result.pet_will_have_baby_id /= 1;
      result.pet_sex_id /= 1;

      _this5.setData({
        pets: result
      });
    });
  }
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImZvcm0ud3hwIl0sIm5hbWVzIjpbInVwbG9hZCIsInJlcXVpcmUiLCJkYXRhIiwicGV0X2NsYXNzX2lkX2luZGV4Iiwic2V4cyIsImJhYnlzIiwiY2xhc3NzIiwicGV0IiwicGV0X3BpY191cmwiLCJwZXRfcGljIiwicGV0X25hbWUiLCJwZXRfY2xhc3NfaWQiLCJwZXRfY2xhc3NfbmFtZSIsInBldF9zZXgiLCJwZXRfc2V4X2lkIiwicGV0X3dpbGxfaGF2ZV9iYWJ5IiwicGV0X3dpbGxfaGF2ZV9iYWJ5X2lkIiwiYmlydGhkYXkiLCJwZXRfaWQiLCJpc0VkaXQiLCJwZXRzIiwib25Mb2FkIiwib3B0aW9ucyIsImlkIiwic2V0RGF0YSIsImdldENsYXNzcyIsImNob29zZUltYWdlIiwiZ2V0QXBwIiwidGhlbiIsInN0YXR1cyIsInNob3dUb2FzdCIsInBpYyIsImNvbnRlbnQiLCJ1cmwiLCJnZXQiLCJtYXAiLCJrZXkiLCJpdGVtIiwibmFtZSIsImdldERldGFpbCIsInNlbGYiLCJmaW5kSW5kZXgiLCJvblNob3ciLCJiaW5kQ2hhbmdlTmFtZSIsImUiLCJrIiwiZGV0YWlsIiwidmFsdWUiLCJkZWxldGVQZXQiLCJkaWFsb2dDb21wb25lbnQiLCJsYXN0Q29tcG9uZW50Iiwic2VsZWN0Q29tcG9uZW50Iiwic2hvdyIsImNhbmNlbERlbGV0ZVBldCIsImhpZGUiLCJjb25maXJtRGVsZXRlUGV0IiwicG9zdCIsInd4IiwibmF2aWdhdGVCYWNrIiwiYmluZENoYW5nZUNsYXNzIiwidiIsImJpbmRDaGFuZ2VTZXgiLCJiaW5kQ2hhbmdlQmFieSIsImJpbmRDaGFuZ2VEYXRlIiwiYWRkUGV0IiwiYXBwIiwidHJpbSIsIlN0cmluZyIsImxlbmd0aCIsImdldFBldHMiLCJyZXN1bHQiXSwibWFwcGluZ3MiOiI7Ozs7O0FBQUEsSUFBTUEsU0FBU0MsUUFBUSx3QkFBUixDQUFmOzs7QUFnQklDLFFBQU07QUFDSkMsd0JBQW9CLEVBRGhCO0FBRUpDLFVBQU0sQ0FBQyxH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QVA7QUFDRDs7QUFHRCxRQUFJLENBQUN2QixJQUFJVSxRQUFULEVBQW1CO0FBQ2pCLGFBQU9nRCxJQUFJbkMsU0FBSixDQUFjLFNBQWQsQ0FBUDtBQUNEOztBQUVEbUMsUUFBSVQsSUFBSixDQUFTdkIsR0FBVCxFQUFjLEtBQUsvQixJQUFMLENBQVVLLEdBQXhCLEVBQTZCcUIsSUFBN0IsQ0FBa0MsZ0JBQVE7QUFDeEM2QixTQUFHQyxZQUFIO0FBQ0QsS0FGRDtBQUdELEc7OztBQUVEVyxXQUFTLG1CQUFZO0FBQUE7O0FBQ25CLFFBQUlKLE1BQU10QyxRQUFWO0FBQ0FzQyxRQUFJL0IsR0FBSixDQUFRLGdCQUFSLEVBQTBCTixJQUExQixDQUErQixnQkFBUTtBQUNyQyxVQUFJMEMsU0FBU3BFLEtBQUtBLElBQUwsQ0FBVThCLE9BQXZCO0FBQ0FzQyxhQUFPdEQscUJBQVAsSUFBZ0MsQ0FBaEM7QUFDQXNELGFBQU94RCxVQUFQLElBQXFCLENBQXJCOztBQUVBLGFBQUtVLE9BQUwsQ0FBYTtBQUNYSixjQUFNa0Q7QUFESyxPQUFiO0FBR0QsS0FSRDtBQVNEIiwiZmlsZSI6ImZvcm0ud3hwIiwic291cmNlc0NvbnRlbnQiOlsiY29uc3QgdXBsb2FkID0gcmVxdWlyZSgnLi4vLi4vY29tbW9uL3VwbG9hZCcpXG5cbiAgZXhwb3J0IGRlZmF1bHQge1xuICAgIGNvbmZpZzoge1xuICAgICAgbmF2aWdhdGlvbkJhclRpdGxlVGV4dDogJ+eMq+WSqueuoeeQhicsXG4gICAgICBuYXZpZ2F0aW9uQmFyQmFja2dyb3VuZENvbG9yOiAnI0U4RThFOCcsXG4gICAgICBuYXZpZ2F0aW9uQmFyVGV4dFN0eWxlOiAnYmxhY2snLFxuICAgICAgdXNpbmdDb21wb25lbnRzOiB7XG4gICAgICAgICd3eGMtZGlhbG9nJzogJ0BtaW51aS93eGMtZGlhbG9nJyxcbiAgICAgICAgJ3d4Yy1hYm5vcic6ICdAbWludWkvd3hjLWFibm9yJyxcbiAgICAgICAgJ3d4Yy1lbGlwJzogJ0BtaW51aS93eGMtZWxpcCcsXG4gICAgICAgICd3eGMtZmxleCc6ICdAbWludWkvd3hjLWZsZXgnLFxuICAgICAgICAnd3hjLWljb24nOiAnQG1pbnVpL3d4Yy1pY29uJyxcbiAgICAgICAgJ3d4Yy1hdmF0YXInOiAnQG1pbnVpL3d4Yy1hdmF0YXInLFxuICAgICAgfVxuICAgIH0sXG4gICAgZGF0YToge1xuICAgICAgcGV0X2NsYXNzX2lkX2luZGV4OiAnJyxcbiAgICAgIHNleHM6IFsn5YWsJywgJ+avjSddLFxuICAgICAgYmFieXM6IFsn5pivJywgJ+WQpiddLFxuICAgICAgY2xhc3NzOiBbXSxcbiAgICAgIHBldDoge1xuICAgICAgICBwZXRfcGljX3VybDogJycsXG4gICAgICAgIHBldF9waWM6ICcnLFxuICAgICAgICBwZXRfbmFtZTogJycsXG4gICAgICAgIHBldF9jbGFzc19pZDogJycsXG4gICAgICAgIHBldF9jbGFzc19uYW1lOiAnJyxcbiAgICAgICAgcGV0X3NleDogJycsXG4gICAgICAgIHBldF9zZXhfaWQ6ICcnLFxuICAgICAgICBwZXRfd2lsbF9oYXZlX2JhYnk6ICcnLFxuICAgICAgICBwZXRfd2lsbF9oYXZlX2JhYnlfaWQ6ICcnLFxuICAgICAgICBiaXJ0aGRheTogJydcbiAgICAgIH0sXG4gICAgICBwZXRfaWQ6IDAsXG4gICAgICBpc0VkaXQ6IGZhbHNlLFxuICAgICAgcGV0czogW10sXG4gICAgfSxcbiAgICBvbkxvYWQ6IGZ1bmN0aW9uIChvcHRpb25zKSB7XG4gICAgICBjb25zdCBwZXRfaWQgPSAob3B0aW9ucy5pZCB8fCAwKSAvIDEgfHwgMFxuICAgICAgdGhpcy5zZXREYXRhKHtcbiAgICAgICAgcGV0X2lkLFxuICAgICAgICBpc0VkaXQ6ICEhcGV0X2lkXG4gICAgICB9LCAoKSA9PiB0aGlzLmdldENsYXNzcygpKVxuICAgIH0sXG5cblx0Y2hvb3NlSW1hZ2UoKSB7XG5cdFx0dXBsb2FkKGdldEFwcCgpKS50aGVuKGRhdGEgPT4ge1xuXHRcdFx0Ly8gZGF0YSA9IGpzb24uanNvbkRlY29kZShkYXRhKVxuXHRcdFx0aWYgKGRhdGEuc3RhdHVzID09IDApXG5cdFx0XHRcdHJldHVybiBnZXRBcHAoKS5zaG93VG9hc3QoJ+S4iuS8oOWksei0pSzor7fph43or5UnKVxuXG4gICAgICBjb25zdCBwaWMgPSBkYXRhLmRhdGEuY29udGVudFxuICAgICAgZGVidWdnZXJcblx0XHRcdHRoaXMuc2V0RGF0YSh7XG5cdFx0XHRcdCdwZXQucGV0X3BpY191cmwnOiBwaWMudXJsLFxuXHRcdFx0XHQncGV0LnBldF9waWMnOiBwaWMucGljLFxuXHRcdFx0fSlcblx0XHR9KVxuXHR9LFxuXG4gICAgZ2V0Q2xhc3NzKCkge1xuICAgICAgZ2V0QXBwKCkuZ2V0KCdwZXQvZ2V0UGV0Q2xhc3MnKS50aGVuKGRhdGEgPT4ge1xuICAgICAgICBjb25zdCBjbGFzc3MgPSBkYXRhLmRhdGEuY29udGVudC5tYXAoaXRlbSA9PiB7XG4gICAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgIGtleTogaXRlbS5wZXRfY2xhc3NfaWQgLyAxLFxuICAgICAgICAgICAgbmFtZTogaXRlbS5wZXRfY2xhc3NfbmFtZVxuICAgICAgICAgIH1cbiAgICAgICAgfSlcblxuICAgICAgICB0aGlzLnNldERhdGEoe1xuICAgICAgICAgIGNsYXNzc1xuICAgICAgICB9KVxuICAgICAgfSkudGhlbigoKSA9PiB0aGlzLmdldERldGFpbCgpKVxuICAgIH0sXG5cbiAgICBnZXREZXRhaWwoKSB7XG4gICAgICBjb25zdCBzZWxmID0gdGhpc1xuXG4gICAgICBpZiAodGhpcy5kYXRhLmlzRWRpdCkge1xuICAgICAgICBnZXRBcHAoKS5nZXQoJ3BldC9vbmU/cGV0X2lkPScgKyB0aGlzLmRhdGEucGV0X2lkKS50aGVuKGRhdGEgPT4ge1xuICAgICAgICAgIGNvbnN0IHBldCA9IGRhdGEuZGF0YS5jb250ZW50XG5cbiAgICAgICAgICBwZXQucGV0X2lkID0gcGV0LnBldF9pZCAvIDFcbiAgICAgICAgICBwZXQucGV0X3dpbGxfaGF2ZV9iYWJ5X2lkID0gcGV0LnBldF93aWxsX2hhdmVfYmFieV9pZCAvIDFcbiAgICAgICAgICBwZXQucGV0X2NsYXNzX2lkID0gcGV0LnBldF9jbGFzc19pZCAvIDFcbiAgICAgICAgICBwZXQucGV0X3NleF9pZCA9IHBldC5wZXRfc2V4X2lkIC8gMVxuXG4gICAgICAgICAgY29uc3QgcGV0X2NsYXNzX2lkX2luZGV4ID0gdGhpcy5kYXRhLmNsYXNzcy5maW5kSW5kZXgoaXRlbSA9PiBpdGVtLmtleSA9PSBwZXQucGV0X2NsYXNzX2lkKVxuXG4gICAgICAgICAgc2VsZi5zZXREYXRhKHtcbiAgICAgICAgICAgIHBldF9jbGFzc19pZF9pbmRleCxcbiAgICAgICAgICAgIHBldFxuICAgICAgICAgIH0pXG4gICAgICAgIH0pXG4gICAgICB9XG4gICAgfSxcblxuICAgIG9uU2hvdzogZnVuY3Rpb24gKCkge1xuICAgICAgLy8gdGhpcy5nZXRQZXRzKClcbiAgICB9LFxuXG4gICAgYmluZENoYW5nZU5hbWUoZSkge1xuICAgICAgY29uc3QgayA9IGUuZGV0YWlsLnZhbHVlXG4gICAgICB0aGlzLnNldERhdGEoe1xuICAgICAgICAncGV0LnBldF9uYW1lJzoga1xuICAgICAgfSlcbiAgICB9LFxuXG4gICAgZGVsZXRlUGV0KCkge1xuICAgICAgbGV0IGRpYWxvZ0NvbXBvbmVudCA9IHRoaXMuZGF0YS5sYXN0Q29tcG9uZW50ID0gdGhpcy5zZWxlY3RDb21wb25lbnQoJy53eGMtY2FuY2VsLXBldCcpXG4gICAgICBkaWFsb2dDb21wb25lbnQgJiYgZGlhbG9nQ29tcG9uZW50LnNob3coKTtcbiAgICB9LFxuXG4gICAgY2FuY2VsRGVsZXRlUGV0KCkge1xuICAgICAgbGV0IGRpYWxvZ0NvbXBvbmVudCA9IHRoaXMuZGF0YS5sYXN0Q29tcG9uZW50ID0gdGhpcy5zZWxlY3RDb21wb25lbnQoJy53eGMtY2FuY2VsLXBldCcpXG4gICAgICBkaWFsb2dDb21wb25lbnQgJiYgZGlhbG9nQ29tcG9uZW50LmhpZGUoKTtcbiAgICB9LFxuXG4gICAgY29uZmlybURlbGV0ZVBldCgpIHtcbiAgICAgIGdldEFwcCgpLnBvc3QoJ3BldC9yZW1vdmVQZXQnLCB7XG4gICAgICAgIHBldF9pZDogdGhpcy5kYXRhLnBldF9pZFxuICAgICAgfSkudGhlbihkYXRhID0+IHtcbiAgICAgICAgd3gubmF2aWdhdGVCYWNrKClcbiAgICAgIH0pXG4gICAgfSxcblxuICAgIGJpbmRDaGFuZ2VDbGFzcyhlKSB7XG4gICAgICBjb25zdCBrID0gZS5kZXRhaWwudmFsdWVcbiAgICAgIGNvbnN0IHYgPSB0aGlzLmRhdGEuY2xhc3NzW2tdXG4gICAgICB0aGlzLnNldERhdGEoe1xuICAgICAgICAncGV0X2NsYXNzX2lkX2luZGV4JzogayxcbiAgICAgICAgJ3BldC5wZXRfY2xhc3NfaWQnOiB2WydrZXknXSxcbiAgICAgICAgJ3BldC5wZXRfY2xhc3NfbmFtZSc6IHZbJ25hbWUnXSxcbiAgICAgIH0pXG4gICAgfSxcblxuICAgIGJpbmRDaGFuZ2VTZXgoZSkge1xuICAgICAgY29uc3QgayA9IGUuZGV0YWlsLnZhbHVlXG4gICAgICBjb25zdCB2ID0gdGhpcy5kYXRhLnNleHNba11cbiAgICAgIHRoaXMuc2V0RGF0YSh7XG4gICAgICAgICdwZXQucGV0X3NleCc6IHYsXG4gICAgICAgICdwZXQucGV0X3NleF9pZCc6IGssXG4gICAgICB9KVxuICAgIH0sXG5cblxuICAgIGJpbmRDaGFuZ2VCYWJ5KGUpIHtcbiAgICAgIGNvbnN0IGsgPSBlLmRldGFpbC52YWx1ZVxuICAgICAgY29uc3QgdiA9IHRoaXMuZGF0YS5iYWJ5c1trXVxuICAgICAgdGhpcy5zZXREYXRhKHtcbiAgICAgICAgJ3BldC5wZXRfd2lsbF9oYXZlX2JhYnknOiB2LFxuICAgICAgICAncGV0LnBldF93aWxsX2hhdmVfYmFieV9pZCc6IGssXG4gICAgICB9KVxuICAgIH0sXG5cbiAgICBiaW5kQ2hhbmdlRGF0ZShlKSB7XG4gICAgICBjb25zdCBrID0gZS5kZXRhaWwudmFsdWVcbiAgICAgIHRoaXMuc2V0RGF0YSh7XG4gICAgICAgICdwZXQuYmlydGhkYXknOiBrXG4gICAgICB9KVxuICAgIH0sXG5cbiAgICBhZGRQZXQoKSB7XG4gICAgICBsZXQgYXBwID0gZ2V0QXBwKClcbiAgICAgIGxldCB1cmwgPSAncGV0L2NyZWF0ZVBldCdcbiAgICAgIGlmICh0aGlzLmRhdGEuaXNFZGl0KVxuICAgICAgICB1cmwgPSAncGV0L3VwZGF0ZVBldD9wZXRfaWQ9JyArIHRoaXMuZGF0YS5wZXRfaWRcblxuICAgICAgY29uc3QgcGV0ID0gdGhpcy5kYXRhLnBldFxuICAgICAgaWYgKCFwZXQucGV0X25hbWUudHJpbSgpKSB7XG4gICAgICAgIHJldHVybiBhcHAuc2hvd1RvYXN0KCfor7fovpPlhaXnjKvlkqrmmLXnp7AnKVxuICAgICAgfVxuXG4gICAgICBpZiAoIXBldC5wZXRfY2xhc3NfaWQpIHtcbiAgICAgICAgcmV0dXJuIGFwcC5zaG93VG9hc3QoJ+ivt+mAieaLqeeMq+WSquenjeexuycpXG4gICAgICB9XG5cbiAgICAgIGlmICghU3RyaW5nKHBldC5wZXRfc2V4X2lkKS5sZW5ndGgpIHtcbiAgICAgICAgcmV0dXJuIGFwcC5zaG93VG9hc3QoJ+ivt+mAieaLqeaAp+WIqycpXG4gICAgICB9XG5cbiAgICAgIGlmICghU3RyaW5nKHBldC5wZXRfd2lsbF9oYXZlX2JhYnlfaWQpLmxlbmd0aCkge1xuICAgICAgICByZXR1cm4gYXBwLnNob3dUb2FzdCgn6K+36YCJ5oup54yr5ZKq5piv5ZCm57ud6IKyJylcbiAgICAgIH1cblxuXG4gICAgICBpZiAoIXBldC5iaXJ0aGRheSkge1xuICAgICAgICByZXR1cm4gYXBwLnNob3dUb2FzdCgn6K+36YCJ5oup54yr5ZKq55Sf5pelJylcbiAgICAgIH1cblxuICAgICAgYXBwLnBvc3QodXJsLCB0aGlzLmRhdGEucGV0KS50aGVuKGRhdGEgPT4ge1xuICAgICAgICB3eC5uYXZpZ2F0ZUJhY2soKVxuICAgICAgfSlcbiAgICB9LFxuXG4gICAgZ2V0UGV0czogZnVuY3Rpb24gKCkge1xuICAgICAgbGV0IGFwcCA9IGdldEFwcCgpXG4gICAgICBhcHAuZ2V0KCdwZXQvZmluZE15UGV0cycpLnRoZW4oZGF0YSA9PiB7XG4gICAgICAgIGxldCByZXN1bHQgPSBkYXRhLmRhdGEuY29udGVudFxuICAgICAgICByZXN1bHQucGV0X3dpbGxfaGF2ZV9iYWJ5X2lkIC89IDFcbiAgICAgICAgcmVzdWx0LnBldF9zZXhfaWQgLz0gMVxuXG4gICAgICAgIHRoaXMuc2V0RGF0YSh7XG4gICAgICAgICAgcGV0czogcmVzdWx0XG4gICAgICAgIH0pXG4gICAgICB9KVxuICAgIH0sXG4gIH0iXX0=